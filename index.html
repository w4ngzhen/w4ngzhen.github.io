<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"compilemind.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="CompileMind">
<meta property="og:url" content="http://compilemind.com/index.html">
<meta property="og:site_name" content="CompileMind">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="w4ngzhen">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://compilemind.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>CompileMind</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CompileMind</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://compilemind.com/2020/11/27/2020-11-27-node-pre-gyp%E4%BB%A5%E5%8F%8Anode-gyp%E7%9A%84%E6%BA%90%E7%A0%81%E7%AE%80%E5%8D%95%E8%A7%A3%E6%9E%90%EF%BC%88%E4%BB%A5%E5%AE%89%E8%A3%85sqlite3%E4%B8%BA%E4%BE%8B%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="w4ngzhen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CompileMind">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/27/2020-11-27-node-pre-gyp%E4%BB%A5%E5%8F%8Anode-gyp%E7%9A%84%E6%BA%90%E7%A0%81%E7%AE%80%E5%8D%95%E8%A7%A3%E6%9E%90%EF%BC%88%E4%BB%A5%E5%AE%89%E8%A3%85sqlite3%E4%B8%BA%E4%BE%8B%EF%BC%89/" class="post-title-link" itemprop="url">node-pre-gyp以及node-gyp的源码简单解析（以安装sqlite3为例）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-11-27 00:00:00" itemprop="dateCreated datePublished" datetime="2020-11-27T00:00:00+08:00">2020-11-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-04 16:42:49" itemprop="dateModified" datetime="2020-12-04T16:42:49+08:00">2020-12-04</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>简单来说，node是跨平台的，那么对于任何的node模块理论也是应该是跨平台的。然而，有些node模块直接或间接使用原生C/C++代码，这些东西要跨平台，就需要使用源码根据实际的操作平台环境进行原生模块编译。SQLite3就是一个经典的原生模块，让我们以安装该模块为例，探索一下安装原生模块的流程。</p>
<h1 id="项目建立"><a href="#项目建立" class="headerlink" title="项目建立"></a>项目建立</h1><p>建立一个简单的node项目，我们开始安装<code>SQLite3</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir sqlite3-install-demo </span><br><span class="line">$ <span class="built_in">cd</span> sqlite3-install-demo</span><br><span class="line">$ npm init</span><br><span class="line"><span class="comment"># 初始化项目</span></span><br><span class="line">Press ^C at any time to quit.</span><br><span class="line">package name: (projects) sqlite3-install-demo</span><br><span class="line">version: (1.0.0)</span><br><span class="line">description:</span><br><span class="line">entry point: (index.js)</span><br><span class="line"><span class="built_in">test</span> <span class="built_in">command</span>:</span><br><span class="line">git repository:</span><br><span class="line">keywords:</span><br><span class="line">author:</span><br><span class="line">license: (ISC) MIT</span><br><span class="line">About to write to D:\Projects\package.json:</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;sqlite3-install-demo&quot;</span>,</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;main&quot;</span>: <span class="string">&quot;index.js&quot;</span>,</span><br><span class="line">  <span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;test&quot;</span>: <span class="string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;author&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;license&quot;</span>: <span class="string">&quot;MIT&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="安装SQLite3"><a href="#安装SQLite3" class="headerlink" title="安装SQLite3"></a>安装<code>SQLite3</code></h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install -S sqlite3</span><br></pre></td></tr></table></figure>
<p>完成命令执行后，你会看到命令行界面出现了如下的几行<strong>重要</strong>的输出：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&gt; sqlite3@5.0.0 install D:\Projects\sqlite3-install-demo\node_modules\sqlite3</span><br><span class="line">&gt; node-pre-gyp install --fallback-to-build</span><br><span class="line"></span><br><span class="line">node-pre-gyp WARN Using request <span class="keyword">for</span> node-pre-gyp https download</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>啪一下，很快啊！我们就迎来了第一个东西<code>node-pre-gyp</code>，但是提到了<code>node-pre-gyp</code>，我们不得不提及<code>node-gyp</code>，然后又不得不提及<code>gyp</code>。</p>
<h1 id="gyp与node-gyp与node-pre-gyp"><a href="#gyp与node-gyp与node-pre-gyp" class="headerlink" title="gyp与node-gyp与node-pre-gyp"></a>gyp与node-gyp与node-pre-gyp</h1><h2 id="什么是gyp？"><a href="#什么是gyp？" class="headerlink" title="什么是gyp？"></a>什么是gyp？</h2><p>gyp全称<code>Generate Your Projects</code>（构建你的项目）。wiki的解释如下，自行翻译：</p>
<blockquote>
<p>GYP (generate your projects) is a build automation tool. GYP was created by Google to generate native IDE project files (such as Visual Studio Code and Xcode) for building the Chromium web browser and is licensed as open source software using the BSD software license.</p>
</blockquote>
<p>重点在于，它是一套用于生成原生IDE项目文件的自动化构建工具，处理C/C++项目，同类型的有CMake、ninja等自动构建工具。</p>
<h2 id="什么是node-gyp？"><a href="#什么是node-gyp？" class="headerlink" title="什么是node-gyp？"></a>什么是node-gyp？</h2><p>直接给出<code>stackoverflow</code>高票回答：</p>
<blockquote>
<p><code>node-gyp</code> is a tool which compiles Node.js Addons. Node.js Addons are native Node.js Modules, written in C or C++, which therefore need to be compiled on your machine. After they are compiled with tools like node-gyp, their functionality can be accessed via <code>require()</code>, just as any other Node.js Module.</p>
</blockquote>
<p>简单来说，node是跨平台的，那么对于任何的node模块理论也是应该是跨平台的。然而，有些node模块直接或间接使用原生C/C++代码，这些东西要跨平台，就需要使用源码根据实际的操作平台环境进行原生模块编译。那么我们需要下载源码文件，通过node-gyp生成一定结构的代码项目让我们能够<code>require</code>引入（譬如，Windows下会生成<code>vcxproj</code>，再调用<code>MSBuild</code>进行编译，以生成Windows下的动态链接库，最后打包为一个原生node模块）。这个知乎回答的每一条可以看看：<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/36291768">传送门</a>。</p>
<h2 id="什么是node-pre-gyp？"><a href="#什么是node-pre-gyp？" class="headerlink" title="什么是node-pre-gyp？"></a>什么是node-pre-gyp？</h2><p>上面<code>node-gyp</code>固然相当方便了，但是每一次安装node原生模块的时候，都需要根据平台（Windows、Linux、macOS以及对应的x86、x64、arm64等等）进行源码编译，这样做费时费力。为什么不一开始就针对这些平台编译好了做成二进制制品发布呢？反正一般来说主流的平台架构就那么一些（Windows、Linux、macOS）。所以<code>node-pre--gyp</code>就帮我们做了这件事。原生模块开发者将代码编译生成各个平台架构的二进制包直接发布到<code>node-pre-gyp</code>上，当我们的node项目安装原生模块时候。处理流程就是首先去<code>node-pre-gyp</code>上找有没有当前平台的组件包，有的话直接拉取使用，如果没有则进行原生编译。</p>
<p><code>node-pre-gyp</code>一些<strong>重要参数</strong>（不全）：</p>
<ul>
<li><code>-C/--directory</code>: run the command in this directory</li>
<li><code>--build-from-source</code>: build from source instead of using pre-built binary</li>
<li><code>--fallback-to-build</code>: fallback to building from source if pre-built binary is not available</li>
<li><code>--target=0.4.0</code>: Pass the target node or node-webkit version to compile against</li>
<li><code>--target_arch=ia32</code>: Pass the target arch and override the host <code>arch</code>. Valid values are ‘ia32’,’x64’, or <code>arm</code>.</li>
<li><code>--target_platform=win32</code>: Pass the target platform and override the host <code>platform</code>. Valid values are <code>linux</code>, <code>darwin</code>, <code>win32</code>, <code>sunos</code>, <code>freebsd</code>, <code>openbsd</code>, and <code>aix</code>.</li>
</ul>
<p>对于<code>--fallback-to-build</code>这个参数：如果二进制不可获取则直接从源码编译，即从<code>node-pre-gyp</code>又回到<code>node-gyp</code>。所以你才会在上文看到安装sqlite3的时候，会有<code>--fallback-to-build</code>。</p>
<p>于是乎，当我们进行node原生模块安装的时候，一般会有如下的流程：</p>
<ol>
<li>针对当前平台架构优先考虑<code>node-pre-gyp</code>方式进行安装，但是为了防止无法获取针对对应平台编译好的二进制包（网络原因、暂时没有对应平台的二进制包），进入第2步；</li>
<li>下载原生模块源码，然后使用<code>node-gyp</code>进行项目构建，得到与平台相关的源码项目文件（Windows则生成<code>vcxproj</code>项目，Linux下是<code>Makefile</code>）；在这个过程，<code>node-gyp</code>会使用<code>Python</code>进行自动化构建操作，这也是为什么有些朋友安装node原生模块的时候，会报错找不到<code>Python</code>。</li>
<li>调用平台对应的编译工具进行编译。在Windows的环境下，<code>node-gyp</code>会查找本地的<code>MSBuild/CL</code>等编译工具，而这些编译工具又一般在<code>Visual Studio</code>安装的时候，也一并安装在了机器上。这就是为什么有些朋友没有安装<code>Visual Studio</code>的时候，会报错。</li>
</ol>
<h1 id="探索SQLite3的安装流程"><a href="#探索SQLite3的安装流程" class="headerlink" title="探索SQLite3的安装流程"></a>探索SQLite3的安装流程</h1><h2 id="npm-install"><a href="#npm-install" class="headerlink" title="npm install"></a><code>npm install</code></h2><p>为什么我们安装<code>sqlite3</code>的时候，会调用<code>node-pre-gyp</code>命令呢？进入<code>项目目录/node_modules/sqlite3/</code>文件夹，让我们查看一下<code>package.json</code>中的<code>scripts</code>部分：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  &quot;repository&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;git&quot;,</span><br><span class="line">    &quot;url&quot;: &quot;git://github.com/mapbox/node-sqlite3.git&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;install&quot;: &quot;node-pre-gyp install --fallback-to-build&quot;, // install</span><br><span class="line">    &quot;pack&quot;: &quot;node-pre-gyp package&quot;,</span><br><span class="line">    &quot;pretest&quot;: &quot;node test/support/createdb.js&quot;,</span><br><span class="line">    &quot;test&quot;: &quot;mocha -R spec --timeout 480000&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;version&quot;: &quot;5.0.0&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>答案显而易见了，<code>install</code>脚本中执行了<code>node-pre-gyp install --fallback-to-build</code>命令。</p>
<p>这就不得不提到<code>npm</code>的安装流程是。当我们进行<code>npm install xxx</code>的时候，<code>npm</code>首先下载<code>xxx</code>的包。下载完成后，若<code>package.json</code>中的scripts中存在<code>install</code>属性，则会立刻调用。至于<code>scripts</code>中的其他固定脚本：<code>test</code>、<code>preinstall</code>、<code>postinstall</code>等等作用以及<code>scripts</code>的高级用法，请直接查阅<a target="_blank" rel="noopener" href="https://docs.npmjs.com/cli/v6/using-npm/scripts">scripts | npm Docs (npmjs.com)</a>。</p>
<p>所以本此<code>sqlite3</code><strong>前期</strong>安装的过程为：</p>
<ol>
<li><code>npm</code>下载在仓库中的<code>sqlite3</code>npm包；</li>
<li>执行<code>$&#123;your_projects&#125;/node_modules/sqlite3/package.json</code>中的<code>install</code>脚本，即<code>node-pre-gyp install --fallback-to-build</code></li>
</ol>
<p>于是乎，安装进入到了一个新的环节：<code>node-pre-gyp install</code>。当然，若你没有全局安装<code>node-pre-gyp</code>，它会由<code>npm</code>帮你安装到<code>$&#123;your_projects&#125;/node_modules/</code>中，并且通过<code>node-pre-gyp/package.json</code>中的<code>bin</code>元素，建立软连接到<code>$&#123;your_projects&#125;/node_modules/.bin</code>中。这样，<code>node\npm</code>环境中就有了<code>node-pre-gyp</code>命令可以使用。至于<code>package.json#bin</code>的作用，详细参考官方文档<a target="_blank" rel="noopener" href="https://docs.npmjs.com/cli/v6/configuring-npm/package-json#bin">package.json | npm Docs (npmjs.com)</a>。</p>
<h2 id="node-pre-gyp-install"><a href="#node-pre-gyp-install" class="headerlink" title="node-pre-gyp install"></a><code>node-pre-gyp install</code></h2><p><code>node-pre-gyp</code>在上述的安装流程中，已经能够被我们在CLI中所使用。查看<code>node_modules/node-pre-gyp/bin/node-pre-gyp</code>文件（下文都将省略<code>$&#123;your_projects&#125;/</code>），用文本的形式打开。就是<code>node-pre-gyp</code>CLI的执行过程，脚本中的主要内容为最后一行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// start running the given commands!</span><br><span class="line">run();</span><br></pre></td></tr></table></figure>
<p>检查该函数的定义：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> command = prog.todo.shift();</span><br><span class="line">  <span class="keyword">if</span> (!command) &#123;</span><br><span class="line">    <span class="comment">// done!</span></span><br><span class="line">    completed = <span class="literal">true</span>;</span><br><span class="line">    log.info(<span class="string">&#x27;ok&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  prog.commands[command.name](command.args, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      log.error(command.name + <span class="string">&#x27; error&#x27;</span>);</span><br><span class="line">      log.error(<span class="string">&#x27;stack&#x27;</span>, err.stack);</span><br><span class="line">      errorMessage();</span><br><span class="line">      log.error(<span class="string">&#x27;not ok&#x27;</span>);</span><br><span class="line">      <span class="built_in">console</span>.log(err.message);</span><br><span class="line">      <span class="keyword">return</span> process.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> args_array = [].slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (args_array.length) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log.apply(<span class="built_in">console</span>, args_array);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// now run the next command in the queue</span></span><br><span class="line">    process.nextTick(run);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>prog</code>是什么？该文件往上查看定义，原来是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> node_pre_gyp = <span class="built_in">require</span>(<span class="string">&#x27;../&#x27;</span>); <span class="comment">// 上一个目录作为模块引入</span></span><br><span class="line"><span class="keyword">var</span> log = <span class="built_in">require</span>(<span class="string">&#x27;npmlog&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Process and execute the selected commands.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> prog = <span class="keyword">new</span> node_pre_gyp.Run(); <span class="comment">// 来自于node_pre_gyp中的Run，而node_pre_gyp在上方</span></span><br></pre></td></tr></table></figure>
<p>继续检查上一个目录，发现并没又<code>indes.js</code>文件，熟悉<code>npm</code>的朋友应该知道要去看<code>package.json</code>中的<code>main</code>元素了：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">	&quot;license&quot;: &quot;BSD-3-Clause&quot;,</span><br><span class="line">	&quot;main&quot;: &quot;./lib/node-pre-gyp.js&quot;, // 模块是这个文件</span><br><span class="line">	&quot;name&quot;: &quot;node-pre-gyp&quot;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>查阅<code>lib/node-pre-gyp.js</code>代码中的Run：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Run</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="built_in">this</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">this</span>.commands = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  commands.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">command</span>) </span>&#123;</span><br><span class="line">    self.commands[command] = <span class="function"><span class="keyword">function</span> (<span class="params">argv, callback</span>) </span>&#123;</span><br><span class="line">      log.verbose(<span class="string">&#x27;command&#x27;</span>, command, argv);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">require</span>(<span class="string">&#x27;./&#x27;</span> + command)(self, argv, callback); <span class="comment">// 这里是核心</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>核心功能就是引入当前所在目录下的模块进行执行。例如，本次调用的是<code>node-pre-gyp install</code>，则会<code>require(./install)</code>，检查一下<code>node-pre-gyp.js</code>目录下，果然存在该<code>js</code>文件。继续阅读<code>install.js</code>源码。里面有几个函数的定义。咱们先不看内容，把函数名列举出来，猜测一下作用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 去下载平台编译好的二进制？</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">download</span>(<span class="params">uri,opts,callback</span>) </span>&#123;...&#125;</span><br><span class="line"><span class="comment">// 把下载好的二进制放到对应目录？</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">place_binary</span>(<span class="params">from,to,opts,callback</span>) </span>&#123;...&#125;</span><br><span class="line"><span class="comment">// 进行构建。难道是没有下载，就调用node-gyp源码编译？</span></span><br><span class="line"><span class="comment">// 还有，node-pre-gyp又--fallback-to-build参数，也会调用这个？</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">do_build</span>(<span class="params">gyp,argv,callback</span>) </span>&#123;...&#125;</span><br><span class="line"><span class="comment">// 打印回退出现的异常</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">print_fallback_error</span>(<span class="params">err,opts,package_json</span>) </span>&#123;...&#125;</span><br><span class="line"><span class="comment">// 安装，核心没跑了</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">install</span>(<span class="params">gyp, argv, callback</span>) </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>
<p>首先看<code>download</code>的调用点是在<code>place_binary</code>中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">place_binary</span>(<span class="params">from,to,opts,callback</span>) </span>&#123; <span class="comment">// place_binary函数</span></span><br><span class="line">    download(<span class="keyword">from</span>,opts,<span class="function"><span class="keyword">function</span>(<span class="params">err,req</span>) </span>&#123; <span class="comment">// 调用了download</span></span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(err);</span><br><span class="line">        <span class="keyword">if</span> (!req) <span class="keyword">return</span> callback(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;empty req&quot;</span>));</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再看<code>place_binary</code>调用点是在<code>install</code>中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">install</span>(<span class="params">gyp, argv, callback</span>) </span>&#123;</span><br><span class="line">	<span class="comment">// 省略部分...</span></span><br><span class="line">    <span class="keyword">var</span> should_do_source_build = source_build === package_json.name || (source_build === <span class="literal">true</span> || source_build === <span class="string">&#x27;true&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (should_do_source_build) &#123; <span class="comment">// 源码编译</span></span><br><span class="line">        log.info(<span class="string">&#x27;build&#x27;</span>,<span class="string">&#x27;requesting source compile&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> do_build(gyp,argv,callback);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 省略部分...</span></span><br><span class="line">        mkdirp(to,<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (err) &#123;</span><br><span class="line">				after_place(err);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				place_binary(<span class="keyword">from</span>,to,opts,after_place); <span class="comment">// 调用点</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">        <span class="comment">// 省略部分...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 省略部分...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过上述分析，整个大的处理流程如下：</p>
<ol>
<li>进入<code>install</code>函数</li>
<li>检查是否需要<code>build-from-source</code>。是则进，入<code>do_build</code>分支，进行源码编译；否则进入步骤3。</li>
<li>检查是否启用<code>--fallback-to-build</code>参数，设定是否启用标志位。</li>
<li>解析编译好的二进制文件的选项配置，譬如二进制文件存放地址，也就是通过请求下载对应二进制包的地址，以及各种各样参数。所以说，为什么下载很慢，我们后文会重点关注下载地址。</li>
</ol>
<h3 id="下载二进制包"><a href="#下载二进制包" class="headerlink" title="下载二进制包"></a>下载二进制包</h3><p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-11-27-node-native-install/hosted_tarball_download.png" alt=""></p>
<p>根据流程，接下来我们进一步检查<code>versioning.js</code>文件，找到其中的<code>evaluate</code>函数，分析最后的<code>hosted_tarball</code>路径：</p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-11-27-node-native-install/analysis_hosted_path.png" alt=""></p>
<p><code>hosted_tarball</code>路径主要分为两个部分：1、<code>hosted_path</code>；2、<code>package_name</code>。</p>
<h4 id="hosted-path"><a href="#hosted-path" class="headerlink" title="hosted_path"></a>hosted_path</h4><p>经过源码分析来源路径为：</p>
<p> <img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-11-27-node-native-install/opts.hosted_path-analysis.png" alt=""></p>
<p>我们自底向上分析。</p>
<p><code>host</code>变量取决于从环境变量中检查名称为<code>&#39;npm_config_&#39; + opts.module_name + &#39;_binary_host_mirror&#39;</code>的环境变量。如果不存在，则使用<code>package_json.binary.host</code>。正常使用的时候，我们并不会设定环境变量，所以这里就进入<code>package_json.binary</code>进行获取。这个<code>package_json</code>是<code>evaluate</code>函数被调用时候传入的，在<code>node-pre-gyp/install.js</code>中能够看到：</p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-11-27-node-native-install/import-gyp.png" alt=""></p>
<p>一开始分析的时候，看到这里，本人以为<code>package_json</code>就是<code>node-pre-gyp/package.json</code>，于是本人去检查该<code>json</code>发现很奇怪，并没有binary属性，更别提host了。一番思考才明白，<code>node-pre-gyp install</code>的运行时调用者是谁呀？不是应该是<code>sqlite3</code>吗？所以这个地方的<code>require(&#39;./package.json&#39;)</code>实际上是指代的是<code>sqlite3/package.json</code>。查看<code>sqlite3/package.json</code>，果然发现了对应的元素：</p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-11-27-node-native-install/sqlite3-binary.png" alt=""></p>
<p>在<code>binary</code>属性中，我们还能看到<code>remote_path</code>也在其中。</p>
<p>至此，<code>hosted_path</code>我们完成了简单的分析，我们可以得出一个结论：</p>
<p><strong><code>node-pre-gyp</code>下载二进制文件的路径，优先来源于对应模块的镜像地址，该镜像地址通过配置<code>&#39;npm_config_&#39; + 模块名 + &#39;_binary_host_mirror&#39;</code>来实现自定义；在没有定义镜像地址的情况下，读取模块<code>package.json</code>中的binary属性信息。</strong></p>
<p>当然，读者可以根据具体情况再进一步分析源码。</p>
<h4 id="package-name"><a href="#package-name" class="headerlink" title="package_name"></a>package_name</h4><p>其实，对于<code>hosted_path</code>的分析，我们也容易分析<code>package_name</code>了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-11-27-node-native-install/opts.package_name-analysis.png" alt=""></p>
<p>自底向上分析，来自于<code>sqlite3/package.json</code>中<code>binary</code>属性中的<code>package_name</code>，内容见上图分析<code>host</code>。</p>
<h4 id="失败处理"><a href="#失败处理" class="headerlink" title="失败处理"></a>失败处理</h4><p><code>--fallback-to-build</code>参数表明了是否进行失败后下载源码进行编译，源码不再分析。</p>
<h3 id="从源码构建"><a href="#从源码构建" class="headerlink" title="从源码构建"></a>从源码构建</h3><h4 id="build-js"><a href="#build-js" class="headerlink" title="build.js"></a>build.js</h4><p>当我们提供了参数<code>--build-from-source</code>或是在下载编译好的二进制到本地出错的时提供了参数<code>--fallback-to-build</code>。node-pre-gyp将进入<code>do_build</code>模块，进行源码编译。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function do_build(gyp,argv,callback) &#123;</span><br><span class="line">  var args &#x3D; [&#39;rebuild&#39;].concat(argv);</span><br><span class="line">  gyp.todo.push( &#123; name: &#39;build&#39;, args: args &#125; );</span><br><span class="line">  process.nextTick(callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中，<code>gyp</code>由调用install的时候，传入：</p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-11-27-node-native-install/gyp-from-install.png" alt=""></p>
<p>那么我们又将回到调用install的地方。实际上，gyp就是node-pre-gyp.js导出的模块：</p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-11-27-node-native-install/node-pre-gyp-export.png" alt=""></p>
<p>也就是说在<code>do_build</code>中进行操作就是，放置了一个<code>build</code>任务在队列中。所以我们按照先前的分析，直接去看<code>build.js</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-11-27-node-native-install/build-buildjs.png" alt=""></p>
<p>看源码调用了当前模块中的<code>do_build</code>，且其中最核心的就是<code>compile</code>模块：</p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-11-27-node-native-install/do_build-buildjs.png" alt=""></p>
<h4 id="util-compile-js"><a href="#util-compile-js" class="headerlink" title="util/compile.js"></a>util/compile.js</h4><p>进入compile模块，直接找到对应的<code>run_gyp</code>函数，代码很短，不难看出进行构建调用了<code>node-gyp</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-11-27-node-native-install/run-gyp.png" alt=""></p>
<p>上述代码，会先考略<code>node-webkit</code>构建。但是我们核心的还是使用<code>node-gyp</code>，所以else中，会进行<code>node-gyp</code>的工具的检查工作。最后调用命令行执行<code>node-gyp</code>。于是，node原生模块的安装工作，进入了新的阶段：<code>node-gyp</code>。</p>
<h2 id="node-gyp-build"><a href="#node-gyp-build" class="headerlink" title="node-gyp build"></a><code>node-gyp build</code></h2><p>上文提到我们已经进入了<code>node-gyp</code>的范畴，会调用<code>node-gyp build</code>操作。当然，这个命令同样是在安装<code>node-gyp</code>依赖的时候已经完成了安装，并且进行<code>node_modules/.bin/</code>软连接操作。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="string">&quot;bin&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;node-gyp&quot;</span>: <span class="string">&quot;bin/node-gyp.js&quot;</span></span><br><span class="line">&#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>我们进入该<code>js</code>进行分析</p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-11-27-node-native-install/node-gyp-GYP.png" alt=""></p>
<p>实际上，<code>node-gyp</code>这段的命令行代码，和<code>node-pre-gyp</code>非常相似！所以我们也不去深入分析调用命令行了。直接在lib文件夹下面的<code>build.js</code>。在该<code>js</code>中，核心的方法为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">build</span> (<span class="params">gyp, argv, callback</span>) </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在该方法中，还编写了几个<strong>内部函数</strong>，作为了功能的划分：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// function build (gyp, argv, callback) 内部函数</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Load the &quot;config.gypi&quot; file that was generated during &quot;configure&quot;.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">loadConfigGypi</span> (<span class="params"></span>) </span>&#123;...&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * On Windows, find the first build/*.sln file.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">findSolutionFile</span> (<span class="params"></span>) </span>&#123;...&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Uses node-which to locate the msbuild / make executable.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">doWhich</span> (<span class="params"></span>) </span>&#123;...&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Search for the location of &quot;msbuild.exe&quot; file on Windows.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">findMsbuild</span> (<span class="params"></span>) </span>&#123;...&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Actually spawn the process and compile the module.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">doBuild</span> (<span class="params"></span>) </span>&#123;...&#125;  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Invoked after the make/msbuild command exits.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">onExit</span> (<span class="params">code, signal</span>) </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>
<p>不得不说，<code>build</code>写的真心不错，看起来很舒服。这里为了方便读者快速阅读，我整理这些函数的调用图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-11-27-node-native-install/node-gyp-build-flow.png" alt=""></p>
<p>整个调用流程图个人认为足够进行安装的时候的一场分析了。至于每个内部函数的功能，有空继续更新本文吧。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://compilemind.com/2020/10/13/2020-10-13-%E5%86%8D%E8%AE%AEWindows%E6%B6%88%E6%81%AF%E4%B8%8EWinForm%E4%BA%8B%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="w4ngzhen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CompileMind">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/13/2020-10-13-%E5%86%8D%E8%AE%AEWindows%E6%B6%88%E6%81%AF%E4%B8%8EWinForm%E4%BA%8B%E4%BB%B6/" class="post-title-link" itemprop="url">再议Windows消息与WinForm事件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-10-13 00:00:00 / Modified: 16:00:59" itemprop="dateCreated datePublished" datetime="2020-10-13T00:00:00+08:00">2020-10-13</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在2月份的时候，我之前曾经写过一篇关于Windows消息与C# WinForm事件机制的文章，名为《WinForm事件与消息》。在那篇文章中，我简单探讨了一下事件和消息。然而如今看来，当时的文章中的案例在运行上存在一定的问题，并且内容也有所缺陷，于是本文将重新优化文章的内容。</p>
<h1 id="消息概述"><a href="#消息概述" class="headerlink" title="消息概述"></a>消息概述</h1><p>Windows下窗体应用程序的执行是通过消息驱动的。所有的外部事件，如键盘输入、鼠标移动、按动鼠标都由用户所触发；然后OS接收到对应的“消息”；然后送入消息队列中；接下来，启动的应用程序的工作引擎通过轮询等方式遍历获取，然后按照消息的类型逐个分发（Dispatch）到对应的组件（例如窗体、按钮等），最后才调用对应组件所注册的事件进行处理。</p>
<h1 id="处理消息"><a href="#处理消息" class="headerlink" title="处理消息"></a>处理消息</h1><p>一般来说，使用WinForm技术进行开发，绝大部分的情况下，我们都在做上述流程的最后一件事情：给各种控件注册事件。毕竟，WinForm真的为我们封装了绝大部分的事件了。而通常的WinForm开发，我们都离不开一个东西：System.Windows.Forms.Application。</p>
<h2 id="System-Windows-Forms-Application"><a href="#System-Windows-Forms-Application" class="headerlink" title="System.Windows.Forms.Application"></a>System.Windows.Forms.Application</h2><p>Application具有用于启动和停止应用程序和线程以及处理Windows消息的方法。例如，调用Run以启动当前线程上的应用程序消息循环，并可以选择使其窗体可见；调用Exit或ExitThread来停止消息循环。所以我们经常使用vs初始化一个基本的WinForm程序，显示的下列模板代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 应用程序的主入口点。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">STAThread</span>]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Application.EnableVisualStyles();</span><br><span class="line">    Application.SetCompatibleTextRenderingDefault(<span class="literal">false</span>);</span><br><span class="line">    Application.Run(<span class="keyword">new</span> Form1()); <span class="comment">// 调用Run以启动当前线程上的应用程序消息循环</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为Application是在单线程中运行的，所以在Application.Run开始后，Application本身不断轮询检查消息队列，然后根据消息类型进行数据分发。例如，当我们为这个Form1增加一个鼠标的点击事件后，我们运行该打开Form1：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Form1 form1 = <span class="keyword">new</span> Form1();</span><br><span class="line">form1.MouseClick += </span><br><span class="line">                (sender, e) =&gt; MessageBox.Show(<span class="string">@&quot;MouseClick 1&quot;</span>);</span><br><span class="line">form1.MouseClick += </span><br><span class="line">                (sender, e) =&gt; MessageBox.Show(<span class="string">@&quot;MouseClick 2&quot;</span>);</span><br><span class="line">Application.Run(form1);</span><br></pre></td></tr></table></figure>
<p>运行后点击Form，可以看到首先出现一个MessageBox，展示“MouseClick 1”，我们点击确定后，又会出现MessageBox，展示“MouseClick 2”。实际上整个过程应该如下：</p>
<p>当我们按下鼠标左键后，消息形成并送往应用程序消息队列中，然后被Application类从应用程序消息队列中取出，然后分发到相应的窗体。窗体使用MouseClick事件中的函数指针调用已经添加的响应函数。所以C#中的事件字段实质上是一个函数指针列表，用来维护一些消息到达时的响应函数的地址。</p>
<p>到目前为止我们可以看到，消息其实在我们进行事件调用的时候，已经被提取加工了，它已经由Application进行了预处理，形成了所谓的“事件调用”。那么，我们还能更加自定义的干预消息吗？答案是可以的。</p>
<h2 id="WndProc"><a href="#WndProc" class="headerlink" title="WndProc"></a>WndProc</h2><p>在.NET框架类库中的System.Windows.Forms命名空间中微软采用面对对象的方式重新定义了Message。该消息主要有一下的几个公共属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">System.Windows.Forms.Message</span><br><span class="line">HWnd     获取或设定消息的处理函数</span><br><span class="line">Msg      获取或设定消息的ID号</span><br><span class="line">Lparam   指定消息的LParam字段</span><br><span class="line">Wparam   指定消息的WParam字段</span><br><span class="line">Result   指定为响应消息处理函数而向OS系统返回的值</span><br></pre></td></tr></table></figure>
<h3 id="WndProc-1"><a href="#WndProc-1" class="headerlink" title="WndProc"></a>WndProc</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;</span><br><span class="line"> &#x2F;&#x2F; 摘要:</span><br><span class="line">&#x2F;&#x2F;     处理 Windows 消息。</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F; 参数:</span><br><span class="line">&#x2F;&#x2F;   m:</span><br><span class="line">&#x2F;&#x2F;     要处理的 Windows System.Windows.Forms.Message。</span><br><span class="line">protected override void WndProc(ref System.Windows.Forms.Message e);</span><br></pre></td></tr></table></figure>
<p>对于每个Form来说，我们都可以重写该方法，该方法的参数就是上面提到的Message类的实例，所有的消息在被获取后，正常情况下都会被封装为Message对象，然后由Application工作引擎调用对用的Form.WndProc传入该Messsage，由于Form子类重写了该方法，所以如果希望底层能处理相关的消息，需要通过base.WndProc传递到父类继续调用。下面就是一个代码示例来展示控制如果当前的消息是鼠标左键点击，则弹出MessageBox展示“WndProc MouseClick”：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">WndProc</span>(<span class="params"><span class="keyword">ref</span> Message m</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> WM_LBUTTONDOWN = <span class="number">0x0201</span>;<span class="comment">// 鼠标左键点击</span></span><br><span class="line">    <span class="keyword">if</span> (m.Msg == WM_LBUTTONDOWN)</span><br><span class="line">    &#123;</span><br><span class="line">        MessageBox.Show(<span class="string">&quot;WndProc MouseClick&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">base</span>.WndProc(<span class="keyword">ref</span> m);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IMessageFilter"><a href="#IMessageFilter" class="headerlink" title="IMessageFilter"></a>IMessageFilter</h3><p>除了上述的WndProc之外，其实更加便于处理应该的实现IMessageFilter接口，然后让Application将实现该接口的消息过滤器添加到Application中：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyMessageFilter</span> : <span class="title">IMessageFilter</span></span><br><span class="line"> &#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">PreFilterMessage</span>(<span class="params"><span class="keyword">ref</span> Message m</span>)</span></span><br><span class="line"><span class="function"></span>     &#123;</span><br><span class="line">         <span class="comment">//返回值为true， 表示消息已被处理，不要再往后传递，因此消息被截获</span></span><br><span class="line">         <span class="comment">//返回值为false，表示消息未被处理，需要再往后传递，因此消息未被截获</span></span><br><span class="line">         <span class="keyword">const</span> <span class="keyword">int</span> WM_LBUTTONDOWN = <span class="number">0x0201</span>;<span class="comment">// 鼠标左键点击</span></span><br><span class="line">         <span class="keyword">if</span> (m.Msg == WM_LBUTTONDOWN)</span><br><span class="line">         &#123;</span><br><span class="line">             MessageBox.Show(<span class="string">&quot;MyMessageFilter MouseClick&quot;</span>);</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>编写完成后，在应用程序初始化的过程中，添加该过滤器：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Application.AddMessageFilter(<span class="keyword">new</span> MyMessageFilter());</span><br></pre></td></tr></table></figure>
<p>同样的，我们启动应用程序并点击实验，可以看到正常的MessageBox输出。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://compilemind.com/2020/08/23/2020-08-29-S_%E5%9E%8B%E6%96%87%E6%B3%95%E5%88%B0q_%E5%9E%8B%E6%96%87%E6%B3%95%E5%86%8D%E5%88%B0LL(1)%E5%9E%8B%E6%96%87%E6%B3%95%E6%BC%94%E8%BF%9B%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="w4ngzhen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CompileMind">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/23/2020-08-29-S_%E5%9E%8B%E6%96%87%E6%B3%95%E5%88%B0q_%E5%9E%8B%E6%96%87%E6%B3%95%E5%86%8D%E5%88%B0LL(1)%E5%9E%8B%E6%96%87%E6%B3%95%E6%BC%94%E8%BF%9B%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">S_型文法到q_型文法再到LL(1)型文法演进笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-23 00:00:00" itemprop="dateCreated datePublished" datetime="2020-08-23T00:00:00+08:00">2020-08-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-13 15:20:30" itemprop="dateModified" datetime="2020-10-13T15:20:30+08:00">2020-10-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="S型文法到q型文法再到LL-1-型文法演进笔记"><a href="#S型文法到q型文法再到LL-1-型文法演进笔记" class="headerlink" title="S型文法到q型文法再到LL(1)型文法演进笔记"></a>S<em>型文法到q</em>型文法再到LL(1)型文法演进笔记</h1><h2 id="S-型文法（简单的确定性文法）"><a href="#S-型文法（简单的确定性文法）" class="headerlink" title="S_型文法（简单的确定性文法）"></a>S_型文法（简单的确定性文法）</h2><ul>
<li><p>每个产生式的右部都以<strong>终结符</strong>开始</p>
</li>
<li><p>同一非终结符的各个候选式的<strong>首终结符</strong>都不同</p>
</li>
</ul>
<p>针对第一条的理解是，只要右部都是终结符开始，那么对于串当前的读入字符，我们可以很容易的直接根据右部开头的终结符来进行判断匹配，而无需进行产生式的推导；针对第二条的理解是，因为首终结符都不一样，所以根据当前串读入的字符，我们只会匹配到一个确定的产生式。</p>
<p>举例，现有文法如下：</p>
<script type="math/tex; mode=display">
\begin{aligned}
&1. \quad S \rightarrow aBC\\
&2. \quad B \rightarrow b\\  
&3. \quad C \rightarrow c\\  
\end{aligned}</script><p>现有字符串$abc$，我们从左部第一个字符开始输入，因为字符$a$能够被产生式1匹配，因此我们首先选择产生式$1. \quad S \rightarrow aBC$；接下来输入第二个字符$b$，于是我们从产生式1到3种进行匹配判断，找到左部非终结符为$B$（找$B$的原因是上一步我们已经匹配到了产生式1，产生式1的右部现在已经匹配上了$a$字符，我们接下来需要推导$B$，所以要找左部为非终结符$B$的产生式)，右部首终结符为$b$的产生式，于是找到产生式2。以此类推，我们最后能够如下的推导：</p>
<script type="math/tex; mode=display">
S \rightarrow aBC \rightarrow abC \rightarrow abc</script><p>个人理解觉得，针对S_型文法的特征是：<strong>我们总是能够根据读入的字符，直接匹配找到一个确定的产生式</strong>。</p>
<p>然而，该文法的局限性非常的大，最基本的一点就是该文法<strong>不包含$\varepsilon$的产生式</strong>。例如，现有下列文法：</p>
<script type="math/tex; mode=display">
\begin{aligned}
&1. \quad S \rightarrow aBC \\
&2. \quad B \rightarrow bC \\
&3. \quad B \rightarrow dB \\
&4. \quad B \rightarrow \varepsilon \\
&5. \quad C \rightarrow c \\
&6. \quad C \rightarrow a \\
&7. \quad D \rightarrow e \\
\end{aligned}</script><p>对于字符串$ade$，首先还是产生式1没得说；接下来，我们需要寻找的是左部为$B$，右部首终结符为$d$的产生式，于是我们选择产生式3，此时产生式推到得到：</p>
<script type="math/tex; mode=display">
\begin{aligned}
& 1. \Rightarrow a，选择产生式1，得到 aBC \\
& 2. \Rightarrow d，选择产生式3，得到 adBC \\
& 3. \Rightarrow e，因为产生式2、3的首位非终结符不是e，这里选择\varepsilon，即选择产生式4，得到 adC \\
\end{aligned}</script><p>因为此时输入字符为$e$，且当前推导的式子中还存在非终结符$C$，于是我们继续应用上述规则进行匹配选择（即，我们结束第3轮，进入第4轮准备开始查找），然而我们无法找到形如$C \rightarrow e…$的产生式，此时报错。</p>
<p>尽管最终报错了，但是当前的文法存在这样一个问题：因为$\varepsilon$产生式的存在，本该在第3轮中就该发现的再无匹配的问题，在第4轮的检查过程中才被发现。为什么说第3轮就该发现呢？我们回到第3轮的检查中，上面说“因为产生式2、3的首位非终结符不是$e$，我们选择$B \rightarrow \varepsilon$，但是选择这个产生式真的正确吗？事实上，当产生式右部是$\varepsilon$的时候，我们应该要考虑空串之后紧跟着的非终结符是什么，如果我们知道紧跟着的非终结符也和当前的输入符号不匹配的话，我们立刻就能知道选择了空串后的下一步必然是无法匹配的。这里$\varepsilon$后面紧跟的等价于$B$紧跟的，那么通过产生式1我们知道$B$后面紧跟的是$C$，而$C$能够推导出$c$和$a$，故在第3轮中，我们首先知道已经无法选择产生式2和3了，接下来我们判断产生式4是否满足，因为当前的输入$e$依然无法和$c$、$a$匹配，所以在第3轮我们已经无法继续进行下去，就应该报错了。</p>
<p>而我们上面所说的“紧跟着的…”也就是接下来要引入的一个概念：$FOLLOW$集。</p>
<h3 id="FOLLOW-集-（后继符号集）"><a href="#FOLLOW-集-（后继符号集）" class="headerlink" title="$FOLLOW 集$（后继符号集）"></a>$FOLLOW 集$（后继符号集）</h3><blockquote>
<p>非终结符$A$的后继符号集<br>可能在某个句型中紧跟在$A$后边的终结符$a$的集合，记为$FOLLOW(A)$</p>
</blockquote>
<script type="math/tex; mode=display">
FOLLOW(A)=\{a|S \Rightarrow^* \alpha Aa\beta, \quad a \in V_T, \quad \alpha, \beta \in (V_T \cup V_N)^*\}</script><p>有了$FOLLOW集$这个东西之后，再回头看待$\varepsilon$产生式就变得很明朗了。</p>
<p>如果当前某非终结符$A$的产生式右部的首字符与输入$a$不匹配的时候，若存在$A \rightarrow \varepsilon$，则我们检查$a$是否存在于$A$的后继符号集$FOLLOW(A)$中，若在其中，则匹配继续，否则程序报错。</p>
<p>于是，对于上面的判断流程的第3步中，$FOLLOW(B) = {a, c}$，而当前我们遇到的符号是$e$，不在对应的集中，于是该步骤已经结束。</p>
<h3 id="SELECT-集-（产生式可选集）"><a href="#SELECT-集-（产生式可选集）" class="headerlink" title="$SELECT 集$（产生式可选集）"></a>$SELECT 集$（产生式可选集）</h3><p>我们综合上述的对于非$\varepsilon$产生式和$\varepsilon$产生式，可以定义产生式的可选集这一概念。</p>
<p>产生式$A \rightarrow \beta$的可选集是指可以选用该产生式进行推导时对应的输入符号的集合，记为$SELECT(A \rightarrow \beta)$。例如：</p>
<p>$SELECT(A \rightarrow \alpha\beta) = {\alpha}$</p>
<p>$SELECT(A \rightarrow \varepsilon) = FOLLOW(A)$</p>
<h2 id="q-文法"><a href="#q-文法" class="headerlink" title="q_文法"></a>q_文法</h2><blockquote>
<p>每个产生式的右部或为$\varepsilon$或以终结符开始</p>
<p>具有相同左部的产生式有不可相交的可选集</p>
</blockquote>
<p>我们称这样的文法为q<em>型文法。为什么引入q</em>型文法，因为前面的$FOLLOW集$概念的引入，解决$\varepsilon$产生式的问题，而这一点可以很好的地对照在q<em>型文法的第一条定义。尽管它对于S</em>型文法限制有了略微的放宽，支持了$\varepsilon$的产生式，可是还是有一定的限制：q_文法不含右部以<code>非终结符</code>打头的产生式。</p>
<p>在前文中，我们总是在限制产生式的右部，要么首字符是一个终结符，要么是$\varepsilon$空串，之所以这样是因为我们总是希望在进行输入的时候右部具有确定的信息（这里就是一个首终结字符）。然而，当右部打头的是非终结符的时候，我们就无从下手了（至少目前是），因为非终结符是不确定的（至少一下子无法知道），它最终能够推导成什么样子的串，似乎变数太多，要是我们事先有一个集合，已经存放好了产生式右部的串(无论它是$\varepsilon$，还是终结符，还是非终结符打头）的首非终结符，每次进行输入匹配的时候，看一下是不是在这里面，问题就迎刃而解了。于是，我们引入概念：串首终结符集。</p>
<h3 id="串首终结符集"><a href="#串首终结符集" class="headerlink" title="串首终结符集"></a>串首终结符集</h3><p>给定一个文法符号串$\alpha$，$\alpha$的串首终结符集$FIRST(\alpha)$被定义为：可以从$\alpha$推导出的所有串首终结符的集合。此外，如果$\alpha \Rightarrow^* \varepsilon$，那么$\varepsilon \in FIRST(\alpha)$。即：</p>
<script type="math/tex; mode=display">
\begin{aligned}
& 对于 \forall \alpha \in (V_T, V_N)^+，FIRST(\alpha) = \{ a | a\beta, \quad a \in V_T, \quad \beta \in (V_T \cup V_N)^* \} \\
& 如果\alpha \Rightarrow^* \varepsilon，那么\varepsilon \in FIRST(\alpha) \\
\end{aligned}</script><p>至于这个串首终结符集如何生成，我们在后文再议。</p>
<p>有了串首终结符集的定义后，我们再次回头看一下产生式$A \rightarrow \alpha$的可选集$SELECT(A \rightarrow \alpha)$。我们先给出定义：</p>
<script type="math/tex; mode=display">
\begin{equation*}
SELECT(A \rightarrow \alpha) = \begin{cases}
FIRST(\alpha), & \text{if} \quad \varepsilon \notin FIRST(\alpha) \\
(FIRST(\alpha) - \{\varepsilon\}) \cup FOLLOW(A), & \text{if} \quad \varepsilon \in FIRST(\alpha)
\end{cases}
\end{equation*}</script><p>我们首先解读这个定义，先看第一种情况，因为$\varepsilon \notin FIRST(\alpha)$，即$\alpha$无法通过任意步骤推导得到空串，即产生式$A \rightarrow \alpha$的左部$A$是无法推导得到空串，那么该产生式的可选集是$FIRST(\alpha)$确实是合理的，试想，现在我有个输入字符c，因为我知道$\varepsilon \notin FIRST(\alpha)$，那么我检查字符c是不是在$FIRST(\alpha)$中就可以做出判断报错还是继续，而无需担心因为左部$A$可以产生空串进而还要考虑$A$的后继符号集；</p>
<p>对于第二种情况，其实就是把空串的情况也考虑了：不仅仅要判断输入字符是不是在右部的串首终结符集中，还因为左部$A$能够推导出空串，而判断是不是在左部的后记符号集中。当然这里排除串首终结符中的空串的含义也是显而易见的，正式因为$A \rightarrow \alpha \Rightarrow^* \varepsilon$，我们才要判断是否在$FOLLOW(A)$中，这里自然要排除空串了。</p>
<h2 id="LL-1-型文法"><a href="#LL-1-型文法" class="headerlink" title="LL(1)型文法"></a>LL(1)型文法</h2><p>在上述理论基础上，我们现在将产生式的右部已经扩展到了任意形式了。于是，我们引入LL(1)型文法。它的定义如下：</p>
<p>文法G是LL(1)的，当且仅当G的任意两个具有相同左部的产生式$A \rightarrow \alpha|\beta$满足如下的条件：</p>
<ol>
<li>如果$\alpha$和$\beta$均不能推导出$\varepsilon$，则$FIRST(\alpha) \cap FIRST(\beta) = \emptyset$。</li>
<li>$\alpha$和$\beta$至多有一个能推导出$\varepsilon$。如果$\beta \Rightarrow^<em> \varepsilon$，则$FIRST(\alpha) \cap FOLLOW(A) = \emptyset$；如果$\alpha \Rightarrow^</em> \varepsilon$，则$FIRST(\beta) \cap FOLLOW(A) = \emptyset$。</li>
</ol>
<p>对于情况1，对于$\alpha$和$\beta$都无法推导出空集的时候，假设两者的串首终结符集的交集不为空，那么对于某个输入字符c，我到底该选择右部为$\alpha$的产生式还是$\beta$的呢？很显然出现了二义性，所以我们有了交集为空集的条件；</p>
<p>对于情况2，首先解释为什么至多有一个能推到出$\varepsilon$。假设都能推导出空集，根据前面产生式的可选集对于右部推导有空集的情况，可选集会包含左部的后记符号集，在这里也就是说，$SELECT(A \rightarrow \alpha)$和$SELECT(A \rightarrow \beta)$都有$FOLLOW(A)$，当输入字符c属于$FOLLOW(A)$的时候，我们应该选择哪一个产生式呢？于是又出现了二义性。所以我们限定只能至多一个能够推导出$\varepsilon$。再进一步，当其中一个右部（这里以$\beta$为例）能够推导出$\varepsilon$，那么$SELECT(A \rightarrow \beta) = {FIRST(\beta) - {\varepsilon}} \cup FOLLOW(A)$，而$\alpha$无法推导出$\varepsilon$，所以$SELECT(A \rightarrow \alpha) = FIRST(\alpha)$，为了保证不会出现二义性，我们需要$SELECT(A \rightarrow \beta) \cap SELECT(A \rightarrow \alpha) = \emptyset$，这里$FIRST(\alpha)$和$FIRST(\beta)$的交集不为空是一个隐藏的条件，因为是情况1的情形；于是，我们还需要保证$FIRST(\alpha) \cap FOLLOW(A) = \emptyset$。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://compilemind.com/2020/08/23/2020-08-23-CefSharp%E8%B5%84%E6%BA%90%E6%8B%A6%E6%88%AA%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="w4ngzhen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CompileMind">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/23/2020-08-23-CefSharp%E8%B5%84%E6%BA%90%E6%8B%A6%E6%88%AA%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">CefSharp请求资源拦截及自定义处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-23 00:00:00" itemprop="dateCreated datePublished" datetime="2020-08-23T00:00:00+08:00">2020-08-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-13 15:20:30" itemprop="dateModified" datetime="2020-10-13T15:20:30+08:00">2020-10-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CefSharp请求资源拦截及自定义处理"><a href="#CefSharp请求资源拦截及自定义处理" class="headerlink" title="CefSharp请求资源拦截及自定义处理"></a>CefSharp请求资源拦截及自定义处理</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在CefSharp中，我们不仅可以使用Chromium浏览器内核，还可以通过Cef暴露出来的各种Handler来实现我们自己的资源请求处理。</p>
<p>什么是资源请求呢？简单来说，就是前端页面在加载的过程中，请求的各种文本（js、css以及html）。在以Chromium内核的浏览器上，我们可以使用浏览器为我们提供的开发者工具来检查每一次页面加载发生的请求。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>鉴于本文的重心是了解CefSharp的资源拦截处理，所以我们不讨论前端的开发以及客户端嵌入CefSharp组件的细节。我们首先完成一个基本的嵌入CefSharp的WinForm程序：该程序界面如下，拥有一个地址输入栏和一个显示网页的Panel：</p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-08-23-cefsharp-resource-intercept/webbrowser.png" alt=""></p>
<p>并且编写一个<strong>极其简单</strong>的页面，该页面会请求1个js资源和1个css资源：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">demo:</span><br><span class="line">    - index.html</span><br><span class="line">    - test1.js</span><br><span class="line">    - test1.css</span><br></pre></td></tr></table></figure>
<p>这几个文件的代码都十分简单：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attribute">background-color</span>: aqua</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunc</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;test1 js file&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/1999/xhtml&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 如下记载js、css资源 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;test1.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;test1.css&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Resource Intercept Example<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">id</span>=<span class="string">&quot;result&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="comment">// 调用test1.js中的myFunc</span></span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.getElementById(<span class="string">&#x27;result&#x27;</span>).innerHTML = myFunc();</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>代码很简单，效果也很容易知道，页面加载后，页面背景色为aqua，页面上会显示文本“test1 js file”。同时，当我们使用开发工具，刷新页面，能够看到对应的资源加载：</p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-08-23-cefsharp-resource-intercept/src-web-page.png" alt=""></p>
<h2 id="CefSharp资源拦截及自定义处理"><a href="#CefSharp资源拦截及自定义处理" class="headerlink" title="CefSharp资源拦截及自定义处理"></a>CefSharp资源拦截及自定义处理</h2><p>完成上述准备后，我们进入正文：资源拦截及自定义处理。首先我们需要对目标的理解达成一致，资源拦截是指我们能够检测到上图中的html、js还有css的资源请求事件，在接下来的Example中，因为我们是使用的客户端程序，所以会在请求的过程中弹出提示；自定义处理是指，在完成拦截提示后，我们还能够替换这些资源，这里我们设定完成拦截后，可以把js和css换为我们想要另外的文件：test2.js和test2.css：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunc</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;test2 js file&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attribute">background-color</span>: beige</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>即我们希望拦截并替换后，页面上的文字不再是之前的，而是“test2 js file”，页面的背景色是beige。</p>
<h3 id="IRequestHandler"><a href="#IRequestHandler" class="headerlink" title="IRequestHandler"></a>IRequestHandler</h3><p>在CefSharp中，要想对请求进行拦截处理，最为核心的Handler就是IRequestHandler这个接口，查看官方的源码，会发现里面有数个方法的定义，通过阅读官方的summary，我们可以聚焦到如下的两个定义（注释本人进行了删减）：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Called before browser navigation.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 译：在浏览器导航前调用</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> If the navigation is allowed <span class="doctag">&lt;see cref=&quot;E:CefSharp.IWebBrowser.FrameLoadStart&quot; /&gt;</span> and <span class="doctag">&lt;see cref=&quot;E:CefSharp.IWebBrowser.FrameLoadEnd&quot; /&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> will be called. If the navigation is canceled <span class="doctag">&lt;see cref=&quot;E:CefSharp.IWebBrowser.LoadError&quot; /&gt;</span> will be called with an ErrorCode</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> value of <span class="doctag">&lt;see cref=&quot;F:CefSharp.CefErrorCode.Aborted&quot; /&gt;</span>.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">OnBeforeBrowse</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  IWebBrowser chromiumWebBrowser,</span></span></span><br><span class="line"><span class="function"><span class="params">  IBrowser browser,</span></span></span><br><span class="line"><span class="function"><span class="params">  IFrame frame,</span></span></span><br><span class="line"><span class="function"><span class="params">  IRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">bool</span> userGesture,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">bool</span> isRedirect</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Called on the CEF IO thread before a resource request is initiated.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 在一个资源请求初始化前在CEF IO线程上调用</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function">IResourceRequestHandler <span class="title">GetResourceRequestHandler</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  IWebBrowser chromiumWebBrowser,</span></span></span><br><span class="line"><span class="function"><span class="params">  IBrowser browser,</span></span></span><br><span class="line"><span class="function"><span class="params">  IFrame frame,</span></span></span><br><span class="line"><span class="function"><span class="params">  IRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">bool</span> isNavigation,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">bool</span> isDownload,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">string</span> requestInitiator,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">ref</span> <span class="keyword">bool</span> disableDefaultHandling</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>于是，我们继承一个默认的名为RequestHandler的类（请区分DefaultRequestHandler），只重写上述的两个方法。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyRequestHandler</span> : <span class="title">RequestHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">bool</span> <span class="title">OnBeforeBrowse</span>(<span class="params">IWebBrowser chromiumWebBrowser, IBrowser browser, IFrame frame, IRequest request, <span class="keyword">bool</span> userGesture,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">bool</span> isRedirect</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 先调用基类的实现，断点调试</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">base</span>.OnBeforeBrowse(chromiumWebBrowser, browser, frame, request, userGesture, isRedirect);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> IResourceRequestHandler <span class="title">GetResourceRequestHandler</span>(<span class="params">IWebBrowser chromiumWebBrowser, IBrowser browser, IFrame frame,</span></span></span><br><span class="line"><span class="function"><span class="params">        IRequest request, <span class="keyword">bool</span> isNavigation, <span class="keyword">bool</span> isDownload, <span class="keyword">string</span> requestInitiator, <span class="keyword">ref</span> <span class="keyword">bool</span> disableDefaultHandling</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 先调用基类的实现，断点调试</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">base</span>.GetResourceRequestHandler(</span><br><span class="line">            chromiumWebBrowser, browser, frame, request, isNavigation, </span><br><span class="line">            isDownload, requestInitiator, <span class="keyword">ref</span> disableDefaultHandling);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>
<p>然后完成对该Handler的注册：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">this</span>._webBrowser = <span class="keyword">new</span> ChromiumWebBrowser(<span class="keyword">string</span>.Empty)</span><br><span class="line">&#123;</span><br><span class="line">    RequestHandler = <span class="keyword">new</span> MyRequestHandler()</span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>
<p>打上断点，开始访问我们的Example：index.html。这里会发现，OnBeforeBrowse调用了一次，而GetResourceRequestHandler会调用3次。检查OnBeforeBrowse中的request参数内容，是一次主页的请求，而GetResourceRequestHandler中的3次分别是：主页html资源、test1.js和test1.css。</p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-08-23-cefsharp-resource-intercept/OnBeforeBrowse.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-08-23-cefsharp-resource-intercept/GetResourceRequestHandler.png" alt=""></p>
<p>结合官方注释和调试的结果，我们可以得出结论：要进行导航的拦截，我们可以重写OnBeforeBrowse方法，要想进行资源的拦截，我们需要实现自己的ResourceRequestHandler。</p>
<h3 id="IResourceRequestHandler"><a href="#IResourceRequestHandler" class="headerlink" title="IResourceRequestHandler"></a>IResourceRequestHandler</h3><p>查看IResourceRequestHandler的定义，我们再次聚焦一个函数定义：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Called on the CEF IO thread before a resource is loaded. To specify a handler for the resource return a <span class="doctag">&lt;see cref=&quot;T:CefSharp.IResourceHandler&quot; /&gt;</span> object</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>To allow the resource to load using the default network loader return null otherwise return an instance of <span class="doctag">&lt;see cref=&quot;T:CefSharp.IResourceHandler&quot; /&gt;</span> with a valid stream<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function">IResourceHandler <span class="title">GetResourceHandler</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  IWebBrowser chromiumWebBrowser,</span></span></span><br><span class="line"><span class="function"><span class="params">  IBrowser browser,</span></span></span><br><span class="line"><span class="function"><span class="params">  IFrame frame,</span></span></span><br><span class="line"><span class="function"><span class="params">  IRequest request</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>该定义从注释可以看出，如果实现返回null，那么Cef会使用默认的网络加载器来发起请求，或者我们可以返回一个自定义的资源处理器ResourceHandler来处理一个合法的数据流（Stream）。也就是说，对于资源的处理，要想实现自定义的处理（不是拦截，拦截到目前为止我们可以在上述的两个Handler中进行处理）我们还需要实现一个IResourceHandler接口的实例，并在GetResourceHandler处进行返回，Cef才会在进行处理的时候使用我们的Handler。所以在<code>GetResourceHandler</code>中，我们进行资源的判断，如果是想要替换的资源，我们就使用WinForm提供的OpenFileDialog来选择本地的js或是css文件，并传给我们自定义的ResourceHandler，如果不是想要拦截的资源或是用户未选择任何的文件就走默认的：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyResourceRequestHandler</span> : <span class="title">ResourceRequestHandler</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> IResourceHandler <span class="title">GetResourceHandler</span>(<span class="params">IWebBrowser chromiumWebBrowser, IBrowser browser, IFrame frame, IRequest request</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (request.Url.EndsWith(<span class="string">&quot;test1.js&quot;</span>) || request.Url.EndsWith(<span class="string">&quot;test1.css&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            MessageBox.Show(<span class="string">$@&quot;资源拦截：<span class="subst">&#123;request.Url&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">string</span> type = request.Url.EndsWith(<span class="string">&quot;.js&quot;</span>) ? <span class="string">&quot;js&quot;</span> : <span class="string">&quot;css&quot;</span>; <span class="comment">// 这里简单判断js还是css，不过多编写</span></span><br><span class="line">            <span class="keyword">string</span> fileName = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">using</span> (OpenFileDialog openFileDialog = <span class="keyword">new</span> OpenFileDialog())</span><br><span class="line">            &#123;</span><br><span class="line">                openFileDialog.Filter = <span class="string">$@&quot;<span class="subst">&#123;type&#125;</span>文件|*.<span class="subst">&#123;type&#125;</span>&quot;</span>; <span class="comment">// 过滤</span></span><br><span class="line">                openFileDialog.Multiselect = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (openFileDialog.ShowDialog() == DialogResult.OK)</span><br><span class="line">                &#123;</span><br><span class="line">                    fileName = openFileDialog.FileName;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrWhiteSpace(fileName))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 没有选择文件，还是走默认的Handler</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">base</span>.GetResourceHandler(chromiumWebBrowser, browser, frame, request);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 否则使用选择的资源返回</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> MyResourceHandler(fileName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">base</span>.GetResourceHandler(chromiumWebBrowser, browser, frame, request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IResourceHandler"><a href="#IResourceHandler" class="headerlink" title="IResourceHandler"></a>IResourceHandler</h3><p>根据上文，我们进一步探究IResourceHandler，对该Handler，官方有一个默认的实现：RequestHandler，该Handler通过阅读源码可以知道是网络加载的Handler，这里为了实现我们自定义拦截策略，我们最好单独实现自己的IResourceHandler。对于该接口，有如下的注释：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Class used to implement a custom resource handler. The methods of this class will always be called on the CEF IO thread.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Blocking the CEF IO thread will adversely affect browser performance. We suggest you execute your code in a Task (or similar).</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> To implement async handling, spawn a new Task (or similar), keep a reference to the callback. When you have a</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> fully populated stream, execute the callback. Once the callback Executes, GetResponseHeaders will be called where you</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> can modify the response including headers, or even redirect to a new Url. Set your responseLength and headers</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Populate the dataOut stream in ReadResponse. For those looking for a sample implementation or upgrading from</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> a previous version <span class="doctag">&lt;see cref=&quot;T:CefSharp.ResourceHandler&quot; /&gt;</span>. For those upgrading, inherit from ResourceHandler instead of IResourceHandler</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> add the override keywoard to existing methods e.g. ProcessRequestAsync.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IResourceHandler</span> : <span class="title">IDisposable</span></span><br><span class="line">&#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>该类的注释意思大致为：我们可以通过实现该接口来实现自定义资源的处理类。该类中的方法总是在CEF的IO线程中调用。然而，阻塞CEF IO线程将会不利于浏览器的性能。所以官方建议开发者通过把自己的处理代码放在Task（或是类似的异步编程框架）中异步执行，然后在完成或取消（失败）时，在异步中调用callback对应的操作函数（continue、cancel等方法）。当你拥有一个完全填充（fully populated）好了的Stream的时候，再执行callback（这一步对应Open方法）。一旦callback执行了，GetResponseHeaders这个方法将会调用，于是你可以在这个方法里面对Reponse的内容包括headers进行修改，或者甚至是重定向到一个新的Url。设置你自己的reponseLength和headers。接下来，通过在ReadResponse（实际上即将作废，而是Read）函数中，实现并填充dataOut这个Stream。最终CEF会对该Stream进行读取数据，获得资源数据。</p>
<p>事实上，该Handler的实现可以有很多花样，这里我们实现一个最简单的。</p>
<h4 id="Dispose"><a href="#Dispose" class="headerlink" title="Dispose"></a>Dispose</h4><p>对于通常进行资源释放的Dispose，因为我们这里只是一个Demo，所以暂时留空。</p>
<h4 id="Open（ProcessRequest）"><a href="#Open（ProcessRequest）" class="headerlink" title="Open（ProcessRequest）"></a>Open（ProcessRequest）</h4><p>官方注释指出，ProcessRequest将会在不久的将来弃用，改为Open。所以ProcessRequest我们直接返回true。对于Open方法，其注释告诉我们：</p>
<ul>
<li>要想要立刻进行资源处理（同步），请设置handleRequest参数为true，并返回true</li>
<li>决定稍后再进行资源的处理（异步），设置handleRequest为false，并调用callback对应的continue和cancel方法来让请求处理继续还是取消，并且当前Open返回false。</li>
<li>要立刻取消资源的处理，设置handleRequest为true，并返回false。</li>
</ul>
<p>也就是说，handleRequest的true或false决定是同步还是异步处理。若同步，则Cef会立刻通过Open的返回值true或false来决定后续继续进行还是取消。若为异步，则Cef会通过异步的方式来检查callback的调用情况（这里的callback实际上是要我们创建Task回调触发的）。这里我们选择同步的方式（选择异步也没有问题）编写如下的代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">Open</span>(<span class="params">IRequest request, <span class="keyword">out</span> <span class="keyword">bool</span> handleRequest, ICallback callback</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    handleRequest = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="GetResponseHeaders"><a href="#GetResponseHeaders" class="headerlink" title="GetResponseHeaders"></a>GetResponseHeaders</h4><p>在上小节中我们已经完成了对资源数据的入口（Open）的分析。既然我们已经告诉了Cef我们准备开始进行资源请求的处理了，那么接下来我们显然需要着手进行资源的处理。根据前面的概要注释，我们需要实现GetResponseHeaders方法，因为这是资源处理的第二步。该方法的注释如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Retrieve response header information. If the response length is not known</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> set <span class="doctag">&lt;paramref name=&quot;responseLength&quot; /&gt;</span> to -1 and ReadResponse() will be called until it</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> returns false. If the response length is known set <span class="doctag">&lt;paramref name=&quot;responseLength&quot; /&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> to a positive value and ReadResponse() will be called until it returns</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> false or the specified number of bytes have been read.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> It is also possible to set <span class="doctag">&lt;paramref name=&quot;response&quot; /&gt;</span> to a redirect http status code</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> and pass the new URL via a Location header. Likewise with <span class="doctag">&lt;paramref name=&quot;redirectUrl&quot; /&gt;</span> it</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> is valid to set a relative or fully qualified URL as the Location header</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> value. If an error occured while setting up the request you can call</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;see cref=&quot;P:CefSharp.IResponse.ErrorCode&quot; /&gt;</span> on <span class="doctag">&lt;paramref name=&quot;response&quot; /&gt;</span> to indicate the error condition.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetResponseHeaders</span>(<span class="params">IResponse response, <span class="keyword">out</span> <span class="keyword">long</span> responseLength, <span class="keyword">out</span> <span class="keyword">string</span> redirectUrl</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>Summary翻译解释如下：获取响应头信息。如果响应的数据长度未知，则设置<code>responseLength</code>为<code>-1</code>，然后CEF会一直调用<code>ReadResponse</code>（即将废除，实际上是<code>Read</code>方法）直到该Read方法返回<code>false</code>。如果响应数据的长度是已知的，可以直接设置<code>responseLength</code>长度为一个正数，然后<code>ReadResponse</code>（<code>Read</code>）将会一直调用，直到该Read方法返回false或者在已经读取的数据的字节长度达到了设置的responseLength的值。当然你也可以通过设置response.StatusCode值为重定向的值（30x）以及redirectUrl为对应的重定向Url来实现资源重定向。</p>
<p>在本文中，我们采取简单的方式：直接返回资源的长度，然后交给下一步的<code>Read</code>方法来进行真正的资源处理。在该步骤中，我们编写获取本地文件字节数据来实现js和css文件的本地加载，并且将该数据保存在该ResourceHanlder实例私有变量中。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetResponseHeaders</span>(<span class="params">IResponse response, <span class="keyword">out</span> <span class="keyword">long</span> responseLength, <span class="keyword">out</span> <span class="keyword">string</span> redirectUrl</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> (FileStream fileStream = <span class="keyword">new</span> FileStream(<span class="keyword">this</span>._localResourceFileName, FileMode.Open, FileAccess.Read))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> (BinaryReader binaryReader = <span class="keyword">new</span> BinaryReader(fileStream))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">long</span> length = fileStream.Length;</span><br><span class="line">            <span class="keyword">this</span>._localResourceData = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</span><br><span class="line">            <span class="comment">// 读取文件中的内容并保存到私有变量字节数组中</span></span><br><span class="line">            binaryReader.Read(<span class="keyword">this</span>._localResourceData, <span class="number">0</span>, <span class="keyword">this</span>._localResourceData.Length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    responseLength = <span class="keyword">this</span>._localResourceData.LongLength;</span><br><span class="line">    redirectUrl = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Read"><a href="#Read" class="headerlink" title="Read"></a>Read</h4><p>该方法的定义和注释如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Read response data. If data is available immediately copy up to</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> dataOut.Length bytes into dataOut, set bytesRead to the number of</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> bytes copied, and return true. To read the data at a later time keep a</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> pointer to dataOut, set bytesRead to 0, return true and execute</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> callback when the data is available (dataOut will remain valid until</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> the callback is executed). To indicate response completion set bytesRead</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> to 0 and return false. To indicate failure set bytesRead to &amp;lt; 0 (e.g. -2</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> for ERR_FAILED) and return false. This method will be called in sequence</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> but not from a dedicated thread.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> </span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> For backwards compatibility set bytesRead to -1 and return false and the ReadResponse method will be called.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Read</span>(<span class="params">Stream dataOut, <span class="keyword">out</span> <span class="keyword">int</span> bytesRead, IResourceReadCallback callback</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>Summary的翻译大致为：读取响应数据。如果数据是可以立即获得的，那么可以直接将<code>dataOut.Length</code>长度的字节数据拷贝到dataOut这个流中，然后设置bytesRead的值为拷贝的数据字节长度值，最后再返回<code>true</code>。如果开发者希望继续持有dataOut的引用（注释是pointer指针，但是个人觉得这里写为指向该dataOut的引用更好）然后在稍后填充该数据流，那么可以设置<code>bytesRead</code>为<code>0</code>，通过异步方式在数据准备好的时候执行callback的操作函数，然后立刻返回<code>true</code>。（dataOut这个流会一直保持不被释放直到callback被调用为止）。为了让CEF知道当前的响应数据已经填充完毕，需要设置<code>bytesRead</code>为<code>0</code>然后返回<code>false</code>。要想让CEF知道响应失败，需要设置<code>bytesRead</code>为一个小于零的数（例如ERR_FAILED: -2），然后返回<code>false</code>。这个方法将会依次调用但不是在一个专有线程。</p>
<p>根据上述的注释，总结如下：</p>
<ul>
<li>bytesRead &gt; 0，return true：填充了数据，但Read还会被调用</li>
<li>bytesRead = 0，return false：数据填充完毕，当前为最后一次调用</li>
<li>bytesRead &lt; 0，return false：出错，当前为最后一次调用</li>
<li>bytesRead = 0，return true：CEF不会释放dataOut流，在异步调用中准备好数据后调用callback</li>
</ul>
<p>针对本例，我们增加一个该类的私有变量<code>_dataReadCount</code>用于标识已读的资源数据字节量并在构造函数中初始化为0。</p>
<p>每次在Read中进行读取的时候，首先检查剩余待读取字节数<code>this._localResourceData.LongLength - this._dataReadCount</code>，如果该值为零，则表明已经将所有的数据通过dataOut拷贝给了外围，此时设置bytesRead为0，直接返回false；若剩余值大于0，则需要继续进行拷贝操作，但需要注意的是dataOut并不是一个无限大的流，而是一个类似于缓存的流，它的Length值为<code>2^16 = 65536</code>，所以我们需要设置bytesRead来让外围知道我们实际在这个流中放了多少字节的数据。同时在使用<code>Stream.Write</code>API的时候，需要设置正确的offset和count。</p>
<p>最终，<code>Read</code>的实现如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">Read</span>(<span class="params">Stream dataOut, <span class="keyword">out</span> <span class="keyword">int</span> bytesRead, IResourceReadCallback callback</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> leftToRead = <span class="keyword">this</span>._localResourceData.Length - <span class="keyword">this</span>._dataReadCount;</span><br><span class="line">    <span class="keyword">if</span> (leftToRead == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        bytesRead = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> needRead = Math.Min((<span class="keyword">int</span>)dataOut.Length, leftToRead); <span class="comment">// 最大为dataOut.Lenght</span></span><br><span class="line">    dataOut.Write(<span class="keyword">this</span>._localResourceData, <span class="keyword">this</span>._dataReadCount, needRead);</span><br><span class="line">    <span class="keyword">this</span>._dataReadCount += needRead;</span><br><span class="line">    bytesRead = needRead;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="其他的几个方法"><a href="#其他的几个方法" class="headerlink" title="其他的几个方法"></a>其他的几个方法</h4><p>对于Cancel和Skip方法，在本例不会调用，所以这里使用默认实现，不进行讨论，感兴趣的伙伴可以自己去研究。</p>
<h2 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h2><p>通过上文的代码设计和编写，我们最终完成了一个简单的资源拦截及自定义处理的Example。首先我们在不进行资源拦截的情况下，加载我们的web页面：</p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-08-23-cefsharp-resource-intercept/load-without-intercept.png" alt=""></p>
<p>可以看到界面中呈现“test1 js file”的字样以及背景色为海蓝色。接下来我们开启资源拦截，再次加载页面，在加载过程中会有对应资源的拦截时的弹窗以及我们需要选择我们自定义的资源文件：</p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-08-23-cefsharp-resource-intercept/js-intercept.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-08-23-cefsharp-resource-intercept/js-select.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-08-23-cefsharp-resource-intercept/css-intercept.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-08-23-cefsharp-resource-intercept/css-select.png" alt=""></p>
<p>完成处理后，得到如下的显示页面：</p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-08-23-cefsharp-resource-intercept/load-with-intercept.png" alt=""></p>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><p>本Example的源码已经开源在Github上，整个Demo较为简单，主要是对本文的验证</p>
<p><a target="_blank" rel="noopener" href="https://github.com/w4ngzhen/CefSharpResourceInterceptExample">链接</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://compilemind.com/2020/08/08/2020-08-08-Electron+Vue+ElementUI%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="w4ngzhen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CompileMind">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/08/2020-08-08-Electron+Vue+ElementUI%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">Electron+Vue+ElementUI开发环境搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-08 00:00:00" itemprop="dateCreated datePublished" datetime="2020-08-08T00:00:00+08:00">2020-08-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-13 15:20:30" itemprop="dateModified" datetime="2020-10-13T15:20:30+08:00">2020-10-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Node环境搭建"><a href="#Node环境搭建" class="headerlink" title="Node环境搭建"></a>Node环境搭建</h2><p>本文假定你完成了nodejs的环境基础搭建：<br>镜像配置（暂时只配置node包镜像源，部分包的二进制镜像源后续讨论）、全局以及缓存路径配置，全局路径加入到了环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"> $</span><span class="bash"> node -v</span></span><br><span class="line"> v12.18.1</span><br><span class="line"><span class="meta"> $</span><span class="bash"> npm -v</span></span><br><span class="line"> 6.14.5</span><br><span class="line"><span class="meta"> $</span><span class="bash"> yarn -v</span></span><br><span class="line"> 1.22.4</span><br><span class="line"> </span><br><span class="line"><span class="meta"> $</span><span class="bash"> npm list -g --depth 0</span></span><br><span class="line"> +-- hexo@4.2.1 // 忽略Hexo，本人写博用的</span><br><span class="line">`-- yarn@1.22.4</span><br></pre></td></tr></table></figure>
<h2 id="vue脚手架安装"><a href="#vue脚手架安装" class="headerlink" title="vue脚手架安装"></a>vue脚手架安装</h2><p>为了更加便捷的创建一个vue项目，我们安装脚手架@vue/cli和@vue/init（vue-cli已经deprecated了）。之所以要安装@vue/init，是因为@vue/cli是3的版本，创建项目使用命令<strong>vue create app-name</strong>，且无法暂时无法使用模板，但是下文要用electron-vue模板进行创建，还是需要vue2的init命令来通过指定模板创建项目，为了兼容vue2的init特性，官方提供@vue/init作为桥接方式。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install -g @vue/cli</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm install -g @vue/cli-init</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm list -g --depth 0</span></span><br><span class="line">+-- @vue/cli@4.4.6</span><br><span class="line">+-- @vue/cli-init@4.4.6</span><br><span class="line">+-- hexo@4.2.1</span><br><span class="line">`-- yarn@1.22.4</span><br><span class="line"></span><br><span class="line">关于init说明：</span><br><span class="line">vue init [options] &lt;template&gt; &lt;app-name&gt;       generate a project from a remote template (legacy API, requires @vue/cli-init)</span><br></pre></td></tr></table></figure>
<p>至此，你可以使用如下的形式，利用vue脚手架结合模板（template）来初始化你的vue项目（app-name）结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue init [options] &lt;template&gt; &lt;app-name&gt;</span><br></pre></td></tr></table></figure>
<h2 id="初始化Electron项目结构"><a href="#初始化Electron项目结构" class="headerlink" title="初始化Electron项目结构"></a>初始化Electron项目结构</h2><p>在指定的目录下，我们使用如下的命令进行electron-vue的项目初始化：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">  vue init simulatedgreg/electron-vue electron-vue-demo</span></span><br></pre></td></tr></table></figure>
<p>然而，这个过程很慢，甚至卡住不动。原因是指定模板进行创建时，会拉取github上的仓库进行模板初始化。幸运的是vue提供模板离线初始化的功能。</p>
<p>下载模板源码</p>
<p><a target="_blank" rel="noopener" href="https://github.com/SimulatedGREG/electron-vue">https://github.com/SimulatedGREG/electron-vue</a></p>
<p>下载后解压存放在 <strong>用户目录/.vue-templates/</strong> 下（没有就创建，注意复数s），形成如下的结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;home目录&#125;&#x2F;</span><br><span class="line">  .vue-templates&#x2F;</span><br><span class="line">     electron-vue-master&#x2F;（目录名随便，但是在待会儿init指定的时候需要一致）</span><br><span class="line">       .github&#x2F;</span><br><span class="line">       template&#x2F;</span><br><span class="line">       ....</span><br></pre></td></tr></table></figure>
<p>之后就可以使用离线（offline）模式创建：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue init --offline electron-vue-master electron-vue-demo # 名称和上述文件夹名称一致即可</span><br></pre></td></tr></table></figure>
<p>之后就是按照向导进行创建工作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ vue init --offline electron-vue-master electron-vue-demo</span><br><span class="line">&gt; Use cached template at ~\.vue-templates\electron-vue-master</span><br><span class="line"></span><br><span class="line">? Application Name electron-vue-demo（项目名）</span><br><span class="line">? Application Id com.compilemind（Id，这里本人使用了自己的域名）</span><br><span class="line">? Application Version 0.0.1（版本）</span><br><span class="line">? Project description electron vue demo（描述）</span><br><span class="line">? Use Sass / Scss? No（是否使用Sass/Scss编译器）</span><br><span class="line">? Select <span class="built_in">which</span> Vue plugins to install (Press &lt;space&gt; to select, &lt;a&gt; to toggle all, &lt;i&gt; to invert selection)</span><br><span class="line">axios, vue-el, ectron, vue-router, vuex, vuex-electron（插件包）</span><br><span class="line">? Use linting with ESLint? Yes（启用ESlint）</span><br><span class="line">? Which ESLint config would you like to use? Standard（ESLint配置）</span><br><span class="line">? Set up unit testing with Karma + Mocha? No（测试模块）</span><br><span class="line">? Set up end-to-end testing with Spectron + Mocha? No（测试模块）</span><br><span class="line">? What build tool would you like to use? builder <span class="comment"># 这里我们使用electron-builder构建可执行程序</span></span><br><span class="line">? author w4ngzhen &lt;w4ngzhen@hotmail.com&gt;</span><br><span class="line"></span><br><span class="line">   vue-cli · Generated <span class="string">&quot;electron-vue-demo&quot;</span>.</span><br></pre></td></tr></table></figure>
<h2 id="运行Electron-Vue示例"><a href="#运行Electron-Vue示例" class="headerlink" title="运行Electron-Vue示例"></a>运行Electron-Vue示例</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cd electron-vue-demo</span><br><span class="line">$ yarn (or &#96;npm install&#96;)</span><br><span class="line">$ yarn run dev (or &#96;npm run dev&#96;)</span><br></pre></td></tr></table></figure>
<p>在install的过程中，我们会看到如下一段console输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> electron@2.0.18 postinstall D:\Projects\electron-vue-demo\node_modules\electron</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> node install.js</span></span><br><span class="line"></span><br><span class="line">Downloading electron-v2.0.18-win32-x64.zip</span><br><span class="line">[==========================================&gt;  ] 97.0% of 50.7 MB (2.77 MB/s)</span><br></pre></td></tr></table></figure>
<p>可以注意到electron的node包安装完成后，配置了postinstall（安装完成后调用的脚本），该脚本执行其内部install.js脚本后，开始下载electron的二进制的文件。</p>
<p>首先为什么会有这个额外下载的过程呢？在本人看来，electron是基于Chromium内核的跨平台客户端解决方案（本人另一篇文章正好进行了CefSharp的封装工作），既然涉及到跨平台，而不同平台的底层实现必然有所差异，那么electron项目通过自己去实现跨平台，封装底层逻辑，让我们不关心底层的实现，而是专心于前端的开发，封装成果就是上述的electron-v2.0.18-win32-x64.zip内容。这里因为我们调试和构建的时候，就需要运行时，所以electron根据我们的当前的平台，去下载了对应已经完成针对平台编译封装的二进制内容。</p>
<p>为什么要下载的问题搞明白了，接下来我们要看看如何去下载。有些朋友可能会发现，自己在进行electron二进制包下载的时候，速度慢的离谱。为什么这么慢？我会过一两天对下载的脚本一探究竟（时间有限，过两天写）</p>
<p>现阶段我们需要在.npmrc文件中增加一行配置，让electron下载二进制文件的时候从指定的地方下载：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ELECTRON_MIRROR=http://npm.taobao.org/mirrors/electron/</span><br></pre></td></tr></table></figure>
<p>完成后，我们在install会发现有明显的提升。完成node包的install后，我们运行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm run dev</span></span><br></pre></td></tr></table></figure>
<p>启动后会发现客户端能够运行起来（即主进程能够运行），但是渲染进程报错：</p>
<p><strong>Webpack ReferenceError:process is not defined</strong>，官方ISSUE已经存在该条：<a target="_blank" rel="noopener" href="https://github.com/SimulatedGREG/electron-vue/issues/871">ISSUE</a></p>
<p>解决方案为：移除src\index.ejs中的该段代码，详细原因可以看ISSUE。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src\index.ejs</span></span><br><span class="line">    &lt;% <span class="keyword">if</span> (!process.browser) &#123; %&gt;</span><br><span class="line">      &lt;script&gt;</span><br><span class="line">        <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">&#x27;development&#x27;</span>) <span class="built_in">window</span>.__static = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>).join(__dirname, <span class="string">&#x27;/static&#x27;</span>).replace(<span class="regexp">/\\/g</span>, <span class="string">&#x27;\\\\&#x27;</span>)</span><br><span class="line">      &lt;/script&gt;</span><br><span class="line">    &lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure>
<p>移除后，再次运行可以看到渲染成功的界面。</p>
<h2 id="引入ElementUI"><a href="#引入ElementUI" class="headerlink" title="引入ElementUI"></a>引入ElementUI</h2><p>引入ElementUI相关包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install element-ui -S</span><br></pre></td></tr></table></figure>
<p>在渲染进程模块的main.js中加入ElementUI组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ElementUI <span class="keyword">from</span> <span class="string">&#x27;element-ui&#x27;</span> </span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;element-ui/lib/theme-chalk/index.css&#x27;</span> </span><br><span class="line">...</span><br><span class="line">Vue.use(ElementUI)</span><br></pre></td></tr></table></figure>
<p>完成配置以后，我们就可以按照以往的方式进行前端的开发了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://compilemind.com/2020/06/06/2020-06-06-CefSharp%E5%9F%BA%E4%BA%8E.Net%20Framework%204.0%20%E6%A1%86%E6%9E%B6%E7%BC%96%E8%AF%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="w4ngzhen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CompileMind">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/06/2020-06-06-CefSharp%E5%9F%BA%E4%BA%8E.Net%20Framework%204.0%20%E6%A1%86%E6%9E%B6%E7%BC%96%E8%AF%91/" class="post-title-link" itemprop="url">CefSharp基于.Net Framework 4.0 框架编译</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-06 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-06T00:00:00+08:00">2020-06-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-13 15:20:30" itemprop="dateModified" datetime="2020-10-13T15:20:30+08:00">2020-10-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本次源码使用的是Github上CefSharp官方的79版本源码</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><h3 id="IDE"><a href="#IDE" class="headerlink" title="IDE"></a>IDE</h3><p>Visual Studio 2017 Enterprise</p>
<h3 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h3><p>Windows10 SDK</p>
<p>VC2013 Redistributale Package x86\x64</p>
<h3 id="组件清单"><a href="#组件清单" class="headerlink" title="组件清单"></a>组件清单</h3><p>以下组件按照顺序进行编译最佳</p>
<h4 id="基础层"><a href="#基础层" class="headerlink" title="基础层"></a>基础层</h4><ul>
<li>CefSharp（C#）</li>
<li>CefSharp.Core（C++）</li>
<li>CefSharp.BrowserSubprocess.Core（C++）</li>
<li>CefSharp.BrowserSubprocess（C#）</li>
</ul>
<h4 id="UI层"><a href="#UI层" class="headerlink" title="UI层"></a>UI层</h4><ul>
<li>CefSharp.WinForms（C#）</li>
</ul>
<h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><ul>
<li><p>CefSharp.Example</p>
</li>
<li><p>CefSharp.WinForms.Example</p>
</li>
</ul>
<h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>建立一个名为CefSharp-DotNet4.0的空的解决方案（下文简称sln哈），咱们就开始吧！</p>
<h3 id="CefSharp"><a href="#CefSharp" class="headerlink" title="CefSharp"></a>CefSharp</h3><p>首先把79版本的源码中的CefSharp库加入到sln中，形成如下的结构：</p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-06-06-build-cefsharp/1.png" alt=""></p>
<p>先不将框架切换为4.0尝试编译一下，出现报错提示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1&gt;------ Rebuild All started: Project: CefSharp, Configuration: Debug x64 ------</span><br><span class="line">1&gt;CSC : error CS7027: Error signing output with public key from file &#39;..\CefSharp.snk&#39; -- File not found.</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; Rebuild All: 0 succeeded, 1 failed, 0 skipped &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>
<p>检查79版本的源码发现，需要将CefSharp.snk文件放置到sln根目录下，这里照做，然后编译通过。</p>
<p>接着切换为4.0尝试编译，编译出现大量错误，仔细检查发现有如下几种：</p>
<p><strong>1、CefSharp.Web.JsonString.FromObject函数的参数DataContractJsonSerializerSettings并不存在</strong></p>
<p><strong>原因</strong>：4.0还不存在该种形式的调用</p>
<p><strong>解决办法</strong>：移除该方法的settings参数，移除DataContractJsonSerializerSettings构造函数的settings参数</p>
<p><strong>2、CefSharp.Internals.ConcurrentMethodRunnerQueue.Enqueue方法中，调用了PropertyInfo.GetValue方法报错</strong></p>
<p><strong>原因</strong>：该PropertyInfo.GetValue方法在4.5及以上可以不传入第二个参数object[] index</p>
<p><strong>解决办法</strong>：GetValue函数传入第二个参数为null即可</p>
<p><strong>3、CefSharp.SchemeHandler.FolderSchemeHandlerFactory.ISchemeHandlerFactory.Create中WebUtility.UrlDecode报错</strong></p>
<p><strong>原因</strong>：该方法是对一般字符串编码为Url的实现，在4.5及以上中才有</p>
<p><strong>解决办法</strong>：实现一个相同的功能的方法替换之，因为后续还有些处理转为4.0后的兼容问题的代码，所以本人在CefSharp增加了一个ExHelper命名空间，用于存放后续的扩展处理代码的Helper，这里首先增加一个WebUtilityHelper的处理类，该类有一个静态方法UrlDecode，其实现本人直接拷贝的.NET 4.7.2的实现，代码如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">CefSharp.ExHelper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> https://referencesource.microsoft.com/#System/net/System/Net/HttpListenerRequest.cs,80a5cbf6a66fa610</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WebUtilityHelper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> _bufferSize;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Accumulate characters in a special array</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> _numChars;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">char</span>[] _charBuffer;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Accumulate bytes for decoding into characters in a special array</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> _numBytes;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">byte</span>[] _byteBuffer;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Encoding to convert chars to bytes</span></span><br><span class="line">        <span class="keyword">private</span> Encoding _encoding;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">internal</span> <span class="title">WebUtilityHelper</span>(<span class="params"><span class="keyword">int</span> bufferSize, Encoding encoding</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            _bufferSize = bufferSize;</span><br><span class="line">            _encoding = encoding;</span><br><span class="line"></span><br><span class="line">            _charBuffer = <span class="keyword">new</span> <span class="keyword">char</span>[bufferSize];</span><br><span class="line">            <span class="comment">// byte buffer created on demand</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">UrlDecode</span>(<span class="params"><span class="keyword">string</span> encodedValue</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (encodedValue == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> UrlDecodeInternal(encodedValue, Encoding.UTF8);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">UrlDecodeInternal</span>(<span class="params"><span class="keyword">string</span> <span class="keyword">value</span>, Encoding encoding</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> count = <span class="keyword">value</span>.Length;</span><br><span class="line">            WebUtilityHelper helper = <span class="keyword">new</span> WebUtilityHelper(count, encoding);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// go through the string&#x27;s chars collapsing %XX and</span></span><br><span class="line">            <span class="comment">// appending each char as char, with exception of %XX constructs</span></span><br><span class="line">            <span class="comment">// that are appended as bytes</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> pos = <span class="number">0</span>; pos &lt; count; pos++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span> ch = <span class="keyword">value</span>[pos];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ch == <span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    ch = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">&#x27;%&#x27;</span> &amp;&amp; pos &lt; count - <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">int</span> h1 = HexToInt(<span class="keyword">value</span>[pos + <span class="number">1</span>]);</span><br><span class="line">                    <span class="keyword">int</span> h2 = HexToInt(<span class="keyword">value</span>[pos + <span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (h1 &gt;= <span class="number">0</span> &amp;&amp; h2 &gt;= <span class="number">0</span>)</span><br><span class="line">                    &#123;     <span class="comment">// valid 2 hex chars</span></span><br><span class="line">                        <span class="keyword">byte</span> b = (<span class="keyword">byte</span>)((h1 &lt;&lt; <span class="number">4</span>) | h2);</span><br><span class="line">                        pos += <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// don&#x27;t add as char</span></span><br><span class="line">                        helper.AddByte(b);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((ch &amp; <span class="number">0xFF80</span>) == <span class="number">0</span>)</span><br><span class="line">                    helper.AddByte((<span class="keyword">byte</span>)ch); <span class="comment">// 7 bit have to go as bytes because of Unicode</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    helper.AddChar(ch);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> helper.GetString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">HexToInt</span>(<span class="params"><span class="keyword">char</span> h</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> (h &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; h &lt;= <span class="string">&#x27;9&#x27;</span>) ? h - <span class="string">&#x27;0&#x27;</span> :</span><br><span class="line">            (h &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; h &lt;= <span class="string">&#x27;f&#x27;</span>) ? h - <span class="string">&#x27;a&#x27;</span> + <span class="number">10</span> :</span><br><span class="line">            (h &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; h &lt;= <span class="string">&#x27;F&#x27;</span>) ? h - <span class="string">&#x27;A&#x27;</span> + <span class="number">10</span> :</span><br><span class="line">            <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">FlushBytes</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_numBytes &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _numChars += _encoding.GetChars(_byteBuffer, <span class="number">0</span>, _numBytes, _charBuffer, _numChars);</span><br><span class="line">                _numBytes = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">internal</span> <span class="keyword">void</span> <span class="title">AddChar</span>(<span class="params"><span class="keyword">char</span> ch</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_numBytes &gt; <span class="number">0</span>)</span><br><span class="line">                FlushBytes();</span><br><span class="line"></span><br><span class="line">            _charBuffer[_numChars++] = ch;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">internal</span> <span class="keyword">void</span> <span class="title">AddByte</span>(<span class="params"><span class="keyword">byte</span> b</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_byteBuffer == <span class="literal">null</span>)</span><br><span class="line">                _byteBuffer = <span class="keyword">new</span> <span class="keyword">byte</span>[_bufferSize];</span><br><span class="line"></span><br><span class="line">            _byteBuffer[_numBytes++] = b;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">internal</span> String <span class="title">GetString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_numBytes &gt; <span class="number">0</span>)</span><br><span class="line">                FlushBytes();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_numChars &gt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> String(_charBuffer, <span class="number">0</span>, _numChars);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> String.Empty;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在报错地方进行如下调用：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> filePath = ExHelper.WebUtilityHelper.UrlDecode(Path.GetFullPath(Path.Combine(rootFolder, asbolutePath)));</span><br></pre></td></tr></table></figure>
<p><strong>4、Type.GetTypeInfo报错</strong></p>
<p><strong>原因</strong>：4.0中没有将Type的信息（TypeInfo）从Type中抽离，所以4.0种的Type并没有GetTypeInfo的方法</p>
<p><strong>解决办法</strong>：4.0访问Type的BaseType、IsGenericType等属性，直接从Type对象调用即可，即如下的形式：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Type type = XXX;</span><br><span class="line"><span class="comment">// 4.0版本</span></span><br><span class="line"><span class="keyword">bool</span> val = type.IsGenericType;</span><br><span class="line">Type baseType = type.BaseType;</span><br><span class="line"><span class="comment">// 4.5以及以上版本</span></span><br><span class="line"><span class="keyword">bool</span> val = type.GetTypeInfo().IsGenericType;</span><br><span class="line">Type baseType = type.GetTypeInfo().BaseType;</span><br></pre></td></tr></table></figure>
<p>这里本人将代码抽离到ExHelper.ReflecionHelper中方便统一调用</p>
<p><strong>5、Task.Run、Task.FromResult以及Task.Delay报错</strong></p>
<p><strong>原因</strong>：在4.0中都不支持上述的几种方式进行调用</p>
<p><strong>解决方案</strong>：通过Nuget加入Microsoft.Bcl、Microsoft.Bcl.Build以及Microsoft.Bcl.Async三个库到本项目中，然后将上述的所有地方的调用都替换为Microsoft.Threading.Tasks.TaskEx，如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 4.5之后</span></span><br><span class="line">Task.Run</span><br><span class="line">Task.FromResult</span><br><span class="line">Task.Delay</span><br><span class="line"><span class="comment">// 4.0，加入了Bcl之后</span></span><br><span class="line">TaskEx.Run</span><br><span class="line">TaskEx.FromResult</span><br><span class="line">TaskEx.Delay</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里讲一下背景，微软发布了Microsoft.Bcl.Async的最终版本，参看博客<a target="_blank" rel="noopener" href="http://blogs.msdn.com/b/bclteam/archive/2013/04/17/microsoft-bcl-async-is-now-stable.aspx">Microsoft.Bcl.Async is Now Stable</a>。该包允许开发者在.NET 4、Silverlight 4和Windows Phone 7.5使用C# 5和VB中的异步特性。该包由三个库组成：Microsoft.Bcl、Microsoft.Bcl.Async和Microsoft.Bcl.Build。<strong>由于使用了<a target="_blank" rel="noopener" href="http://msdn.microsoft.com/en-us/library/db7849ey.aspx">程序集统一</a>的方式，解决方案中的所有工程都必须引用这三个库</strong>。</p>
<p>C#发展至今，已经从最初的1.0到了5.0版本：</p>
<ol>
<li>1.0版本 - 基本C#语法。</li>
<li>2.0版本 - 泛型的支持，CLR进行了升级，从根本上支持了运行时泛型。</li>
<li>3.0版本 - LINQ，添加了<code>from</code> / <code>join</code>等类SQL关键字，添加了扩展函数，添加了编译期动态类型var关键字。</li>
<li>4.0版本 - dynamic关键字，CLR进行升级，加入DLR，开始对动态进行友好的支持。同时加入动态参数、参数默认值、泛型协变等特性。</li>
<li>5.0版本 - async/await关键字，将异步变得更为简单。</li>
</ol>
<p>async/await 将异步的编程模型统一为同步模型，简化开发复杂度，提升生产效率。微软正式发布了Microsoft.Bcl.Async的最终版本，这让.NET4里头也可以用上async/await，而不需要把项目更改为.net 4.5。</p>
</blockquote>
<p>这里为了统一入口，本人把这几个TaskEx的调用收口到ExHelper.TaskHelper中便于查找改动点。</p>
<p>目前为止，我们应该解决了CefSharp库所有的问题，再次Rebuild该项目，Succeeded！</p>
<h3 id="CefSharp-Core"><a href="#CefSharp-Core" class="headerlink" title="CefSharp.Core"></a>CefSharp.Core</h3><p>CefSharp.Core是一个C++的库，但是由于该C++库里面调用了一些C#代码，所以跟.Net Framework版本出现了相关性。这里我们同上一样，把79版本的CefSharp.Core源码加入到sln中，右键该项目，打开菜单最下面的properties：</p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-06-06-build-cefsharp/2.png" alt=""></p>
<p>这里我们修改3个点：</p>
<p>1、选择Windows SDK Version。点击Windows SDK Version右边的下拉框，选择我们安装的Windos10 SDK，如果你和我的SDK版本安装的是一样的，应该就是10.0.17763.0，但是理论上Windows8以上的SDK都应该没啥问题；</p>
<p>2、选择Platform Toolset为我们安装的IDE的版本，这里我的就是Visual Studio 2017；</p>
<p>3、手动填入.NET Target Framework Version 为：”v4.0”。</p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-06-06-build-cefsharp/3.png" alt=""></p>
<p>完成上述修改后，我们还需要进行如下的操作：</p>
<p>拷贝79版本源码解决方案根目录下的CefSharp.props文件到本sln根目录下</p>
<p>这么做的原因是在CefSharp.Core的vcxproj文件中（VC++项目编译文件），有一处Import（自行搜索）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Import</span> <span class="attr">Project</span>=<span class="string">&quot;..\CefSharp.props&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后我们进行编译Rebuild，不出意外应该还是有大量的错误，乍一看出现的错误似乎让人摸不着头脑，什么” ‘AssmblyInfo’ : is not a class or namesapce name”等C#问题，可是明显在这些.NET 4.0上没有问题。本人突然想起以前在学校学习C/C++的时候，老师告诉我们处理C/C++编译处理一定要从最上面看，仔细看命令行编译最开始的地方有两处warning：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">warning MSB3268: The primary reference &quot;E:\Projects\CefSharp-DotNet4.0\CefSharp\bin\x64\Debug\CefSharp.dll&quot; could not be resolved because it has an indirect dependency on the framework assembly &quot;System.Runtime, Version&#x3D;1.5.11.0, Culture&#x3D;neutral, PublicKeyToken&#x3D;b03f5f7f11d50a3a&quot; which could not be resolved in the currently targeted framework. &quot;.NETFramework,Version&#x3D;v4.0&quot;. To resolve this problem, either remove the reference &quot;E:\Projects\CefSharp-DotNet4.0\CefSharp\bin\x64\Debug\CefSharp.dll&quot; or retarget your application to a framework version which contains &quot;System.Runtime, Version&#x3D;1.5.11.0, Culture&#x3D;neutral, PublicKeyToken&#x3D;b03f5f7f11d50a3a&quot;.</span><br><span class="line"></span><br><span class="line">warning MSB3268: The primary reference &quot;E:\Projects\CefSharp-DotNet4.0\CefSharp\bin\x64\Debug\CefSharp.dll&quot; could not be resolved because it has an indirect dependency on the framework assembly &quot;System.Threading.Tasks, Version&#x3D;1.5.11.0, Culture&#x3D;neutral, PublicKeyToken&#x3D;b03f5f7f11d50a3a&quot; which could not be resolved in the currently targeted framework. &quot;.NETFramework,Version&#x3D;v4.0&quot;. To resolve this problem, either remove the reference &quot;E:\Projects\CefSharp-DotNet4.0\CefSharp\bin\x64\Debug\CefSharp.dll&quot; or retarget your application to a framework version which contains &quot;System.Threading.Tasks, Version&#x3D;1.5.11.0, Culture&#x3D;neutral, PublicKeyToken&#x3D;b03f5f7f11d50a3a&quot;.</span><br></pre></td></tr></table></figure>
<p>这两个warning说我们的CefSharp因为Tasks相关动态库的版本不对无法编译，但是我们之前CefSharp已经完成了编译，似乎没有什么问题。实际上，我们CefSharp为了兼容使用了Bcl相关组件，上面我们提到：</p>
<blockquote>
<p><strong>由于使用了<a target="_blank" rel="noopener" href="http://msdn.microsoft.com/en-us/library/db7849ey.aspx">程序集统一</a>的方式，解决方案中的所有工程都必须引用这三个库</strong>。</p>
</blockquote>
<p>实际上C++的工程代码也不例外，所以我们添加Bcl库代码到工程中，由于nuget似乎无法为C++工程添加包，所以本人采用手工的方式添加：</p>
<p>1、在vcxproj文件的适当位置添加如下的节点引入Bcl包里面的组件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">......</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Reference</span> <span class="attr">Include</span>=<span class="string">&quot;System.ServiceModel&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Reference</span> <span class="attr">Include</span>=<span class="string">&quot;System.Runtime&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">HintPath</span>&gt;</span>..\packages\Microsoft.Bcl.1.1.10\lib\net40\System.Runtime.dll<span class="tag">&lt;/<span class="name">HintPath</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Reference</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Reference</span> <span class="attr">Include</span>=<span class="string">&quot;System.Threading.Tasks&quot;</span>&gt;</span>           	       <span class="tag">&lt;<span class="name">HintPath</span>&gt;</span>..\packages\Microsoft.Bcl.1.1.10\lib\net40\System.Threading.Tasks.dll<span class="tag">&lt;/<span class="name">HintPath</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Reference</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ClCompile</span> <span class="attr">Include</span>=<span class="string">&quot;AssemblyInfo.cpp&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">......</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2、让编译的时候识别到该Nuget包，vcxproj文件末尾添加：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">......</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">ImportGroup</span> <span class="attr">Label</span>=<span class="string">&quot;ExtensionTargets&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Import</span> <span class="attr">Project</span>=<span class="string">&quot;..\packages\Microsoft.Bcl.Build.1.0.21\build\Microsoft.Bcl.Build.targets&quot;</span> <span class="attr">Condition</span>=<span class="string">&quot;Exists(&#x27;..\packages\Microsoft.Bcl.Build.1.0.21\build\Microsoft.Bcl.Build.targets&#x27;)&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ImportGroup</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Target</span> <span class="attr">Name</span>=<span class="string">&quot;EnsureNuGetPackageBuildImports&quot;</span> <span class="attr">BeforeTargets</span>=<span class="string">&quot;PrepareForBuild&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ErrorText</span>&gt;</span>This project references NuGet package(s) that are missing on this computer. Use NuGet Package Restore to download them.  For more information, see http://go.microsoft.com/fwlink/?LinkID=322105. The missing file is &#123;0&#125;.<span class="tag">&lt;/<span class="name">ErrorText</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Error</span> <span class="attr">Condition</span>=<span class="string">&quot;!Exists(&#x27;..\packages\Microsoft.Bcl.Build.1.0.21\build\Microsoft.Bcl.Build.targets&#x27;)&quot;</span> <span class="attr">Text</span>=<span class="string">&quot;$([System.String]::Format(&#x27;$(ErrorText)&#x27;, &#x27;..\packages\Microsoft.Bcl.Build.1.0.21\build\Microsoft.Bcl.Build.targets&#x27;))&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>3、修改packge.config文件（没有则新增）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">packages</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- cef.sdk是需要的依赖包 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">package</span> <span class="attr">id</span>=<span class="string">&quot;cef.sdk&quot;</span> <span class="attr">version</span>=<span class="string">&quot;79.1.36&quot;</span> <span class="attr">targetFramework</span>=<span class="string">&quot;native&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">package</span> <span class="attr">id</span>=<span class="string">&quot;Microsoft.Bcl&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.1.10&quot;</span> <span class="attr">targetFramework</span>=<span class="string">&quot;net40&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">package</span> <span class="attr">id</span>=<span class="string">&quot;Microsoft.Bcl.Async&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0.168&quot;</span> <span class="attr">targetFramework</span>=<span class="string">&quot;net40&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">package</span> <span class="attr">id</span>=<span class="string">&quot;Microsoft.Bcl.Build&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0.21&quot;</span> <span class="attr">targetFramework</span>=<span class="string">&quot;net40&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">packages</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>上述操作完成后需要进行Restore还原一下cef.sdk的NuGet包，然后再次进行编译，发现warning已经消除，但是还是编译失败，还是有很多“报错”，本人一开始找问题也找了很久以为全都是error，后来发现很多都是warning，最后发现2处关键点error（你们可以先自行搜索这两个地方，双击就可以跳转到对应的报错处）：</p>
<p><strong>1、</strong>在CefSharp::Internals::Serialization中的SerializeV8SimpleObject有一处GetValue调用报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error C2661: &#39;System::Reflection::PropertyInfo::GetValue&#39;: no overloaded function takes 1 arguments</span><br></pre></td></tr></table></figure>
<p><strong>2、</strong>在CefSharp::Internals::JavascriptCallbackProxy中的ExecuteWithTimeoutAsync有一处调用报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error C2039: &#39;FromResult&#39;: is not a member of &#39;System::Threading::Tasks::Task&#39;</span><br></pre></td></tr></table></figure>
<p>这两处很明显是使用了C#的代码，且该代码是 .Net4.0不支持的，原因以及解决方法在上面的CefSharp中已经说了。这里我们修改按照C++语法改写下代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、</span><br><span class="line"><span class="keyword">auto</span> propertyValue = properties[i]-&gt;GetValue(obj); <span class="comment">// 4.5.2</span></span><br><span class="line"><span class="keyword">auto</span> propertyValue = properties[i]-&gt;GetValue(obj, <span class="literal">nullptr</span>); <span class="comment">// 4.0</span></span><br><span class="line"><span class="number">2</span>、</span><br><span class="line"><span class="built_in">Task</span>::FromResult(invalidFrameResponse); <span class="comment">// 4.5.2</span></span><br><span class="line">ExHelper::TaskHelper::FromResult(invalidFrameResponse); <span class="comment">// 4.0 命名空间就对应的CefSharp里面的Helper</span></span><br></pre></td></tr></table></figure>
<p>完成操作后，Rebuild sln，Succeeded！</p>
<h3 id="CefSharp-BrowserSubprocess-Core"><a href="#CefSharp-BrowserSubprocess-Core" class="headerlink" title="CefSharp.BrowserSubprocess.Core"></a>CefSharp.BrowserSubprocess.Core</h3><p>同上操作，将4.5.2源码加入到sln中，和上述CefSharp.Core相同方式：</p>
<p>1、修改properties；</p>
<p><strong>2、增加Bcl包的依赖到vsxproj中。</strong></p>
<p>完成操作后，直接进行Rebuild操作，因为该C++库并不涉及到C#的代码，所以只需要做上述增加Bcl库的相关操作，编译成功！</p>
<h3 id="CefSharp-BrowserSubprocess"><a href="#CefSharp-BrowserSubprocess" class="headerlink" title="CefSharp.BrowserSubprocess"></a>CefSharp.BrowserSubprocess</h3><p>同上操作，将4.5.2源码加入到sln中，然后：<strong>1、切换版本为.NET 4.0；2、增加Bcl相关依赖包。</strong>因为是C#项目我们终于不用手工给csproj添加节点了，可以使用nuget添加Bcl三个包。</p>
<p>添加完成后我们尝试编译该组件，不知道为什么，在我的机器上编译过程会出现如下的错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">找不到命令的错误提示</span><br></pre></td></tr></table></figure>
<p>但是查看编译结果还有输出目录能够看到是编译成功的，我也索性没有继续看下去了</p>
<h3 id="CefSharp-WinForm"><a href="#CefSharp-WinForm" class="headerlink" title="CefSharp.WinForm"></a>CefSharp.WinForm</h3><p>终于到我们的UI层了，如上方式添加源码到项目里，然后：<strong>1、切换版本为.NET 4.0；2、增加Bcl相关依赖包。</strong>（如果你切换了框架后，右键该项目-Manage NuGet Packages出现报错nuget is invalid，请尝试关闭解决方案重新打开）。编译该项目，不出意外，编译成功～</p>
<p>至此，跟.NET Framework绑定的代码已经全部编译通过，本来到此步骤，我们的编译工作已经完成了，但是官方提供了Example让我们可以调用看看样例，本人索性把Example和WinForm.Example两个工程也一并.NET 4.0化了。</p>
<h3 id="CefSharp-Example"><a href="#CefSharp-Example" class="headerlink" title="CefSharp.Example"></a>CefSharp.Example</h3><p>该组件并非是必须组件，但是后续无论是Wpf还是WinForm的Example运行，都需要该组件，所以我们还是把它也.NET 4.0化。</p>
<p>还是上述方式，添加到项目，然后：<strong>1、切换版本为.NET 4.0；2、增加Bcl相关依赖包。</strong>最后尝试进行编译，出现编译错误：</p>
<p><strong>1、在CefSharp.Example.Handlers.DownloadHandler.OnBeforeDownloadFired函数中，定义的Eventhandler的泛型参数DownloadItem并不是EventArgs子类</strong></p>
<p><strong>原因</strong>：在4.5之后，EventHandler的泛型参数可以不是EventArgs的子类，而在.Net 4.0必须是继承自EventArgs</p>
<p><strong>解决办法</strong>：因为DownloadItem较为公共，我们不方便将其继承EventArgs，所以我们单独写一个自己的EventHandler，让其泛型参数接收任意类型：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">delegate</span> <span class="keyword">void</span> <span class="title">DownloadEventHandler</span>&lt;<span class="keyword">in</span> <span class="title">T</span>&gt;(<span class="params"><span class="keyword">object</span> sender, T args</span>)</span>;</span><br><span class="line"><span class="comment">// 改成我们的自己的下载事件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">event</span> DownloadEventHandler&lt;DownloadItem&gt; OnBeforeDownloadFired;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">event</span> DownloadEventHandler&lt;DownloadItem&gt; OnDownloadUpdatedFired;</span><br></pre></td></tr></table></figure>
<p>再次编译，还会有一些剩下的和Task相关的编译报错问题，上文已经解释了原因和提供了解决方案，Do It！完成修改后，编译成功！</p>
<h3 id="CefSharp-WinForm-Example"><a href="#CefSharp-WinForm-Example" class="headerlink" title="CefSharp.WinForm.Example"></a>CefSharp.WinForm.Example</h3><p>我们依然如上的方式进行工程的添加，添加的过程会弹出提示框报如下的错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">---------------------------</span><br><span class="line">Microsoft Visual Studio</span><br><span class="line">---------------------------</span><br><span class="line">The imported project &quot;E:\Projects\CefSharp-DotNet4.0\CefSharp.Native.props&quot; was not found. Confirm that the path in the &lt;Import&gt; declaration is correct, and that the file exists on disk.  E:\Projects\CefSharp-DotNet4.0\CefSharp.WinForms.Example\CefSharp.WinForms.Example.csproj</span><br><span class="line">---------------------------</span><br><span class="line">确定   </span><br><span class="line">---------------------------</span><br></pre></td></tr></table></figure>
<p>上述提示表明，我们缺少CefSharp.Native.props，在官方源码中的解决方案根目录下找到对应的文件拷贝到我们的目录下。拷贝完成后，<strong>我们先不进行切换Framework和添加Bcl依赖包的操作</strong>，我们首先打开该项目的package.config文件，可以看到有如下的内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">id</span>=<span class="string">&quot;cef.redist.x64&quot;</span> <span class="attr">version</span>=<span class="string">&quot;79.1.36&quot;</span> <span class="attr">targetFramework</span>=<span class="string">&quot;net462&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">id</span>=<span class="string">&quot;cef.redist.x86&quot;</span> <span class="attr">version</span>=<span class="string">&quot;79.1.36&quot;</span> <span class="attr">targetFramework</span>=<span class="string">&quot;net462&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">id</span>=<span class="string">&quot;Microsoft.Net.Compilers&quot;</span> <span class="attr">version</span>=<span class="string">&quot;2.9.0&quot;</span> <span class="attr">targetFramework</span>=<span class="string">&quot;net462&quot;</span> <span class="attr">developmentDependency</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>很明显和我们即将要切换的.NET4.0不符合，接下来我们再进行如下操作：</p>
<p>1、先Restore这些NuGet包，然后卸载掉，最后再切换为4.0；</p>
<p>2、<strong>只安装Bcl相关组件包，不安装上述卸载的cef.redist和Compiler</strong></p>
<p>进行编译，不出意外会出现如下的几个编译错误：</p>
<p><strong>1、error CS0117: ‘TaskContinuationOptions’ does not contain a definition for ‘HideScheduler’</strong></p>
<p><strong>原因</strong>：Net4.0中没有这个定义</p>
<p><strong>解决办法</strong>：因为是Demo，我们使用的TaskContinuationOptions.None的枚举暂时避过编译</p>
<p><strong>2、error CS0103: The name ‘AppContext’ does not exist in the current context</strong></p>
<p><strong>原因</strong>：Net4.0中没有这个定义</p>
<p><strong>解决办法</strong>：这里的目的是获取CefSharp.Example\Extensions里面的文件，我们使用System.AppDomain.CurrentDomain.BaseDirectory即可</p>
<p>剩下的几个编译问题还是Task的问题，不在赘述。</p>
<p>完成编译以后，我们尝试运行该WinForm.Example，提示：</p>
<blockquote>
<p>未能加载文件或程序集“CefSharp.Core.dll”或它的某一个依赖项。找不到指定的模块</p>
</blockquote>
<p>检查Bin目录下的，发现已经有了该dll，那么就是缺少了CefSharp.Core.dll需要的组件。实际上，刚才我们移除了2个NuGet依赖包：</p>
<p>cef.redist.x64、cef.redist.x86，这里面是Cef的核心资源与类库，就包含了CefSharp.Core所需要的所有资源。</p>
<p>重新安装这两个组件包，但需要注意的是对应版本一定要对应当前的版本（79.1.36）。安装完成后，我们检查packages里面的cef.redist组件包，可以看到CEF文件夹下面有我们需要的ceflib.dll等类库和资源：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">locales(dir)</span><br><span class="line">swiftshader(dir)</span><br><span class="line">cef.pak</span><br><span class="line">cef_100_percent.pak</span><br><span class="line">cef_200_percent.pak</span><br><span class="line">cef_extensions.pak</span><br><span class="line">chrome_elf.dll</span><br><span class="line">d3dcompiler_47.dll</span><br><span class="line">devtools_resources.pak</span><br><span class="line">icudtl.dat</span><br><span class="line">libcef.dll</span><br><span class="line">libEGL.dll</span><br><span class="line">libGLESv2.dll</span><br><span class="line">natives_blob.bin</span><br><span class="line">README.txt</span><br><span class="line">snapshot_blob.bin</span><br><span class="line">v8_context_snapshot.bin</span><br></pre></td></tr></table></figure>
<p>我们再次运行，终于出现关于WinForm的Example！</p>
<h2 id="制品梳理"><a href="#制品梳理" class="headerlink" title="制品梳理"></a>制品梳理</h2><ul>
<li>NuGet引用Microsoft.Bcl、Microsoft.Bcl.Build以及Microsoft.Bcl.Async</li>
</ul>
<p>引入上述3个依赖库组件是因为我们为了将CefSharp代码使用.NET 4.0进行编译，兼容async/await等Task相关的特性而引入的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Miscrosoft.Threading.Tasks.dll</span><br><span class="line">Miscrosoft.Threading.Tasks.Extensions.dll</span><br><span class="line">Miscrosoft.Threading.Tasks.Extensions.Desktop.dll</span><br><span class="line">System.IO.dll</span><br><span class="line">System.Runtime.dll</span><br><span class="line">System.Threading.Tasks.dll</span><br></pre></td></tr></table></figure>
<ul>
<li>NuGet引用cef.redist. x86/x64</li>
</ul>
<p>该NuGet包中包含Cef原生需要的组件和资源包，包括核心的ceflib.dll，具体内容请查看packages/cef.redist. x86/x64/CEF中的所有。</p>
<ul>
<li>基于DotNet 4.0编译的CefSharp核心依赖库</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CefSharp（C#）</span><br><span class="line">CefSharp.Core（C++）</span><br><span class="line">CefSharp.BrowserSubprocess.Core（C++）</span><br><span class="line">CefSharp.BrowserSubprocess（C#）</span><br><span class="line">CefSharp.WinForms（C#）</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://compilemind.com/2020/04/06/2020-04-06-Git%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E5%8F%82%E8%80%83%E6%89%8B%E5%86%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="w4ngzhen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CompileMind">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/06/2020-04-06-Git%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E5%8F%82%E8%80%83%E6%89%8B%E5%86%8C/" class="post-title-link" itemprop="url">Git常用命令参考手册</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-06 00:00:00" itemprop="dateCreated datePublished" datetime="2020-04-06T00:00:00+08:00">2020-04-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-13 15:20:30" itemprop="dateModified" datetime="2020-10-13T15:20:30+08:00">2020-10-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Git常用命令参考手册"><a href="#Git常用命令参考手册" class="headerlink" title="Git常用命令参考手册"></a>Git常用命令参考手册</h1><p>基本git命令</p>
<hr>
<h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><ul>
<li><a href="#配置">配置</a></li>
<li><a href="#初始化本地仓库">初始化本地仓库</a></li>
<li><a href="#文件状态">文件状态</a></li>
<li><a href="#日志">日志</a></li>
<li><a href="#克隆">克隆</a></li>
<li><a href="#查看分支">查看分支</a></li>
<li><a href="#切换分支">切换分支</a></li>
<li><a href="#创建分支">创建分支</a></li>
<li><a href="#删除分支">删除分支</a></li>
<li><a href="#重命名分支">重命名分支</a></li>
<li><a href="#代码合并">代码合并</a></li>
<li><a href="#暂存">暂存</a></li>
<li><a href="#删除">删除</a></li>
<li><a href="#提交">提交</a></li>
<li><a href="#推送">推送</a></li>
<li><a href="#提交">提交</a></li>
<li><a href="#拉取、获取内容">拉取、获取内容</a></li>
<li><a href="#查看文件的改动">查看文件的改动</a></li>
<li><a href="#回滚版本">回滚版本</a></li>
<li><a href="#撤销">撤销</a></li>
<li><a href="#标签">标签</a></li>
<li><a href="#其他">其他</a></li>
</ul>
<h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看配置列表</span></span><br><span class="line">git config -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看已设置的用户名</span></span><br><span class="line">git config --global --get user.name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置用户名</span></span><br><span class="line">git config --global user.name <span class="variable">$&#123;username&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看已设置的邮箱</span></span><br><span class="line">git config --global --get user.email</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置邮箱</span></span><br><span class="line">git config --global user.email <span class="string">&quot;example@example.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上述配置均可在用户目录下的.gitconfig文件中进行查看配置</span></span><br></pre></td></tr></table></figure>
<h3 id="初始化本地仓库"><a href="#初始化本地仓库" class="headerlink" title="初始化本地仓库"></a>初始化本地仓库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 会在当前目录生成.git</span></span><br><span class="line">git init</span><br></pre></td></tr></table></figure>
<h3 id="文件状态"><a href="#文件状态" class="headerlink" title="文件状态"></a>文件状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br></pre></td></tr></table></figure>
<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看完整历史提交记录</span></span><br><span class="line">git <span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看前2次提交记录 commit message</span></span><br><span class="line">git <span class="built_in">log</span> -2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看前2次提交记录，包括diff</span></span><br><span class="line">git <span class="built_in">log</span> -p -2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索关键词</span></span><br><span class="line">git <span class="built_in">log</span> -S 你好</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出提交者贡献数量</span></span><br><span class="line">git shortlog -sn</span><br><span class="line"></span><br><span class="line"><span class="comment"># 单行简要显示内容</span></span><br><span class="line">git <span class="built_in">log</span> --oneline</span><br></pre></td></tr></table></figure>
<h3 id="克隆"><a href="#克隆" class="headerlink" title="克隆"></a>克隆</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https 协议</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/<span class="variable">$&#123;username&#125;</span>/<span class="variable">$&#123;git-repo&#125;</span>.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># SSH协议</span></span><br><span class="line">git <span class="built_in">clone</span> git@github.com:<span class="variable">$&#123;username&#125;</span>/<span class="variable">$&#123;git-repo&#125;</span>.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 克隆某个分支， -b 后面分支名字</span></span><br><span class="line">git <span class="built_in">clone</span> -b <span class="variable">$&#123;branch-name&#125;</span> https://github.com/<span class="variable">$&#123;username&#125;</span>/<span class="variable">$&#123;git-repo&#125;</span>.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 递归克隆，适用于项目中包含子模块</span></span><br><span class="line">git <span class="built_in">clone</span> --recursive <span class="variable">$&#123;username&#125;</span>@github.com/<span class="variable">$&#123;username&#125;</span>/<span class="variable">$&#123;git-repo&#125;</span>.git</span><br></pre></td></tr></table></figure>
<h2 id="分支操作"><a href="#分支操作" class="headerlink" title="分支操作"></a>分支操作</h2><h3 id="查看分支"><a href="#查看分支" class="headerlink" title="查看分支"></a>查看分支</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有分支</span></span><br><span class="line">git branch --all</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看本地分支</span></span><br><span class="line">git branch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看远程仓库地址</span></span><br><span class="line">git remote -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看远端分支</span></span><br><span class="line">git branch -r</span><br></pre></td></tr></table></figure>
<h3 id="切换分支"><a href="#切换分支" class="headerlink" title="切换分支"></a>切换分支</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 2种方法，切换到master分支</span></span><br><span class="line">git checkout master</span><br><span class="line">git switch master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换上一个分支</span></span><br><span class="line">git checkout -</span><br></pre></td></tr></table></figure>
<h3 id="创建分支"><a href="#创建分支" class="headerlink" title="创建分支"></a>创建分支</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建dev分支</span></span><br><span class="line">git branch dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建develop分支并切换</span></span><br><span class="line">git checkout -b dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换远端分支</span></span><br><span class="line">git checkout -t origin/dev</span><br></pre></td></tr></table></figure>
<h3 id="删除分支"><a href="#删除分支" class="headerlink" title="删除分支"></a>删除分支</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除本地分支</span></span><br><span class="line">git branch -d <span class="variable">$&#123;branchName&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除远程分支</span></span><br><span class="line">git branch -d -r origin/<span class="variable">$&#123;branchName&#125;</span></span><br><span class="line">git push origin :<span class="variable">$&#123;branchName&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="重命名分支"><a href="#重命名分支" class="headerlink" title="重命名分支"></a>重命名分支</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重命名当前分支</span></span><br><span class="line">git branch -m <span class="variable">$&#123;branchName&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="代码合并"><a href="#代码合并" class="headerlink" title="代码合并"></a>代码合并</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 两步法, 将feature分支代码合并到dev</span></span><br><span class="line"><span class="comment"># 1、切换到dev分支</span></span><br><span class="line">git checkout dev</span><br><span class="line"><span class="comment"># 2、将feature合并到当前dev分支</span></span><br><span class="line">git merge feature</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同上效果</span></span><br><span class="line">git merge feature dev</span><br></pre></td></tr></table></figure>
<h2 id="内容操作"><a href="#内容操作" class="headerlink" title="内容操作"></a>内容操作</h2><h3 id="暂存"><a href="#暂存" class="headerlink" title="暂存"></a>暂存</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 暂存所有</span></span><br><span class="line">git add -A</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暂存某个文件</span></span><br><span class="line">git add ./README.md</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加当前目录所有改动文件</span></span><br><span class="line">git add .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暂存一系列文件</span></span><br><span class="line">git add 1.txt 2.txt ...</span><br></pre></td></tr></table></figure>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p>git add 的反向操作<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除1.txt 文件</span></span><br><span class="line">git rm 1.txt</span><br></pre></td></tr></table></figure></p>
<h3 id="提交"><a href="#提交" class="headerlink" title="提交"></a>提交</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -m 提交的信息</span></span><br><span class="line">git commit -m <span class="string">&quot;changes log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交显示diff变化</span></span><br><span class="line">git commit -v</span><br></pre></td></tr></table></figure>
<h3 id="推送"><a href="#推送" class="headerlink" title="推送"></a>推送</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 推送内容到主分支</span></span><br><span class="line">git push -u origin master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地分支推送到远程， 本地分支:远程分支</span></span><br><span class="line">git push origin <span class="variable">$&#123;localBranchName&#125;</span>:<span class="variable">$&#123;remoteBranchName&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 简写，默认推送当前分支</span></span><br><span class="line">git push</span><br><span class="line"></span><br><span class="line"><span class="comment"># 强制推送, -f =&gt; --force</span></span><br><span class="line">git push -f</span><br></pre></td></tr></table></figure>
<h3 id="拉取、获取内容"><a href="#拉取、获取内容" class="headerlink" title="拉取、获取内容"></a>拉取、获取内容</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取远端名为master的分支，但不会进行自动合并，需要手动merge</span></span><br><span class="line">git fetch origin master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 等同于git fetch 然后 git merge</span></span><br><span class="line">git pull</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉去远端分支master到本地分支master</span></span><br><span class="line">git pull origin master:master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取远端分支master到本地【当前】分支</span></span><br><span class="line">git pull origin master</span><br></pre></td></tr></table></figure>
<h3 id="查看文件的改动"><a href="#查看文件的改动" class="headerlink" title="查看文件的改动"></a>查看文件的改动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有文件改动</span></span><br><span class="line">git diff</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看具体文件的改动</span></span><br><span class="line">git diff README.md</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看某个版本的改动, 后面那一窜是commitId， git log后就能看到</span></span><br><span class="line">git diff <span class="variable">$&#123;commitId&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看某个文件的历史修改记录</span></span><br><span class="line">git <span class="built_in">log</span> README.md</span><br><span class="line">git show <span class="variable">$&#123;commitId&#125;</span> README.md</span><br></pre></td></tr></table></figure>
<h3 id="回滚版本"><a href="#回滚版本" class="headerlink" title="回滚版本"></a>回滚版本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 回滚上一个版本</span></span><br><span class="line">git reset --hard HEAD^</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回滚上两个版本</span></span><br><span class="line">git reset --hard HEAD^^</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回退到指定版本，git log 就能看到commit id了</span></span><br><span class="line">git reset --hard <span class="string">&#x27;$&#123;commitId&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 回滚版本是不保存在 git log，如果想查看使用</span></span><br><span class="line">git reflog</span><br></pre></td></tr></table></figure>
<h3 id="撤销"><a href="#撤销" class="headerlink" title="撤销"></a>撤销</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 撤销当前目录下所有文件的改动</span></span><br><span class="line">git checkout -- .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 撤销指定文件修改</span></span><br><span class="line">git checkout -- README.md</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暂存区回到工作区, 指定 ./README.md 文件从暂存区回到工作区</span></span><br><span class="line">git reset HEAD ./README.md</span><br><span class="line"></span><br><span class="line"><span class="comment"># 撤销commit, 回到工作区, 一般commitId是前一个</span></span><br><span class="line">git reset <span class="variable">$&#123;commitId&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 撤销commit, 并且把修改同时撤销</span></span><br><span class="line">git reset --hard <span class="variable">$&#123;commitId&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出本地所有标签</span></span><br><span class="line">git tag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出远程所有标签</span></span><br><span class="line">git ls-remote --tags origin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按照特定模式查找标签, `*` 模板搜索</span></span><br><span class="line">git tag -l <span class="string">&quot;v1.0.0*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建带有附注标签</span></span><br><span class="line">git tag -a v1.1.0 -m <span class="string">&quot;标签描述&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建轻量标签, 不需要带任何参数</span></span><br><span class="line">git tag v1.1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后期打标签, 假设之前忘记打标签了，可以通过git log查看commit id</span></span><br><span class="line">git <span class="built_in">log</span></span><br><span class="line">git tag -a v1.1.0 <span class="variable">$&#123;commitId&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送到远程，默认只是本地创建</span></span><br><span class="line">git push origin v1.1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一次性推送所有标签到远程</span></span><br><span class="line">git push origin --tags</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除标签, 你需要再次运行 git push origin v1.1.0 才能删除远程标签</span></span><br><span class="line">git tag -d v1.1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除远程标签</span></span><br><span class="line">git push origin --delete v1.1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查标签</span></span><br><span class="line">git checkout v1.1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看本地某个标签详细信息</span></span><br><span class="line">git show v1.1.0</span><br></pre></td></tr></table></figure>
<h3 id="密码配置"><a href="#密码配置" class="headerlink" title="密码配置"></a>密码配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 记住提交账号密码</span></span><br><span class="line">git config --global credential.helper store</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清除git已保存的用户名和密码</span></span><br><span class="line"><span class="comment"># windows</span></span><br><span class="line">git credential-manager uninstall</span><br><span class="line"><span class="comment"># mac linux</span></span><br><span class="line">git config --global credential.helper store</span><br></pre></td></tr></table></figure>
<h2 id="License"><a href="#License" class="headerlink" title="License"></a>License</h2><h3 id="MIT"><a href="#MIT" class="headerlink" title="MIT"></a>MIT</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://compilemind.com/2020/02/05/2020-02-05-WinForm%E4%BA%8B%E4%BB%B6%E4%B8%8E%E6%B6%88%E6%81%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="w4ngzhen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CompileMind">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/05/2020-02-05-WinForm%E4%BA%8B%E4%BB%B6%E4%B8%8E%E6%B6%88%E6%81%AF/" class="post-title-link" itemprop="url">WinForm事件与消息</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-05 00:00:00" itemprop="dateCreated datePublished" datetime="2020-02-05T00:00:00+08:00">2020-02-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-13 15:20:30" itemprop="dateModified" datetime="2020-10-13T15:20:30+08:00">2020-10-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="消息概述以及在C-下的封装"><a href="#消息概述以及在C-下的封装" class="headerlink" title="消息概述以及在C#下的封装"></a>消息概述以及在C#下的封装</h3><p>Windows下应用程序的执行是通过消息驱动的。所有的外部事件，如键盘输入、鼠标移动、按动鼠标都由OS系统转换成相应的“消息”，进入到应用程序的消息队列中，由应用程序引擎轮询处理。在C#中，消息被应用程序的工作引擎通过轮询等方式遍历获取并按照消息的类型逐个分发到对应的组件（例如窗体、按钮等），最后调用对应组件所注册的事件进行处理。</p>
<p>在.NET框架类库中的System.Windows.Forms命名空间中微软采用面对对象的方式重新定义了Message。该消息主要有一下的几个公共属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">System.Windows.Forms.Message</span><br><span class="line">HWnd     获取或设定消息的处理函数</span><br><span class="line">Msg      获取或设定消息的ID号</span><br><span class="line">Lparam   指定消息的LParam字段</span><br><span class="line">Wparam   指定消息的WParam字段</span><br><span class="line">Result   指定为响应消息处理函数而向OS系统返回的值</span><br></pre></td></tr></table></figure>
<h3 id="System-Windows-Forms-Application"><a href="#System-Windows-Forms-Application" class="headerlink" title="System.Windows.Forms.Application"></a>System.Windows.Forms.Application</h3><p>System.Windows.Forms.Application类具有用于启动和停止应用程序和线程以及处理Windows消息的方法。例如，调用Run以启动当前线程上的应用程序消息循环，并可以选择使其窗体可见；调用Exit或ExitThread来停止消息循环。所以我们经常使用vs初始化一个基本的WinForm程序，显示的下列模板代码：<br><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 应用程序的主入口点。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">STAThread</span>]</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Application.EnableVisualStyles();</span><br><span class="line">    Application.SetCompatibleTextRenderingDefault(<span class="literal">false</span>);</span><br><span class="line">    Application.Run(<span class="keyword">new</span> Form1()); <span class="comment">// 调用Run以启动当前线程上的应用程序消息循环</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>因为Application是在单线程中运行的，所以在Application.Run开始后，Application本身不断轮询检查消息队列，然后根据消息类型进行数据分发。例如，当我们为这个Form1增加一个鼠标的点击事件后，我们运行该打开Form1：<br><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Form1 form1 = <span class="keyword">new</span> Form1();</span><br><span class="line">form1.MouseClick += (sender, e) =&gt; MessageBox.Show(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">form1.MouseClick += (sender, e) =&gt; MessageBox.Show(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">Application.Run(form1);</span><br></pre></td></tr></table></figure><br>运行后点击Form，可以看到首先出现一个MessageBox，展示“1”，我们点击确定后，又会出现MessageBox，展示“2”。实际上整个过程应该如下：</p>
<p>当我们按下鼠标左键后，消息形成并送往应用程序消息队列中，然后被Application类从应用程序消息队列中取出，然后分发到相应的窗体。窗体使用MouseClick事件中的函数指针调用已经添加的响应函数。所以C#中的事件字段实质上是一个函数指针列表，用来维护一些消息到达时的响应函数的地址。</p>
<p>到目前为止我们可以看到，消息其实在我们进行事件调用的时候，已经被提取加工了，它已经由Application进行了预处理，形成了所谓的“事件调用”。那么，我们还能更加自定义的干预消息吗？答案是可以的。</p>
<h3 id="WndProc"><a href="#WndProc" class="headerlink" title="WndProc"></a>WndProc</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;</span><br><span class="line"> &#x2F;&#x2F; 摘要:</span><br><span class="line">&#x2F;&#x2F;     处理 Windows 消息。</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F; 参数:</span><br><span class="line">&#x2F;&#x2F;   m:</span><br><span class="line">&#x2F;&#x2F;     要处理的 Windows System.Windows.Forms.Message。</span><br><span class="line">protected override void WndProc(ref System.Windows.Forms.Message e);</span><br></pre></td></tr></table></figure>
<p>对于每个Form来说，我们都可以重写该方法，该方法的参数就是上面提到的Message类的实例，所有的消息在被获取后，正常情况下都会被封装为Message对象，然后由Application工作引擎调用对用的Form.WndProc传入该Messsage，由于Form子类重写了该方法，所以如果希望底层能处理相关的消息，需要通过base.WndProc传递到父类继续调用。下面就是一个代码示例来展示控制如果当前的消息是鼠标左键点击，则弹出MessageBox展示“WndProc MouseClick”：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">WndProc</span>(<span class="params"><span class="keyword">ref</span> Message m</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> WM_LBUTTONDOWN = <span class="number">0x0201</span>;<span class="comment">// 鼠标左键点击</span></span><br><span class="line">    <span class="keyword">if</span> (m.Msg == WM_LBUTTONDOWN)</span><br><span class="line">    &#123;</span><br><span class="line">        MessageBox.Show(<span class="string">&quot;WndProc MouseClick&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">base</span>.WndProc(<span class="keyword">ref</span> m);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IMessageFilter"><a href="#IMessageFilter" class="headerlink" title="IMessageFilter"></a>IMessageFilter</h3><p>除了上述的WndProc之外，其实更加便于处理应该的实现IMessageFilter接口，然后让Application将实现该接口的消息过滤器添加到Application中：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyMessageFilter</span> : <span class="title">IMessageFilter</span></span><br><span class="line"> &#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">PreFilterMessage</span>(<span class="params"><span class="keyword">ref</span> Message m</span>)</span></span><br><span class="line"><span class="function"></span>     &#123;</span><br><span class="line">         <span class="comment">//返回值为true， 表示消息已被处理，不要再往后传递，因此消息被截获</span></span><br><span class="line">         <span class="comment">//返回值为false，表示消息未被处理，需要再往后传递，因此消息未被截获</span></span><br><span class="line">         <span class="keyword">const</span> <span class="keyword">int</span> WM_LBUTTONDOWN = <span class="number">0x0201</span>;<span class="comment">// 鼠标左键点击</span></span><br><span class="line">         <span class="keyword">if</span> (m.Msg == WM_LBUTTONDOWN)</span><br><span class="line">         &#123;</span><br><span class="line">             MessageBox.Show(<span class="string">&quot;MyMessageFilter MouseClick&quot;</span>);</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>编写完成后，在应用程序初始化的过程中，添加该过滤器：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Application.AddMessageFilter(<span class="keyword">new</span> MyMessageFilter());</span><br></pre></td></tr></table></figure>
<p>同样的，我们启动应用程序并点击实验，可以看到正常的MessageBox输出。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://compilemind.com/2020/02/04/2020-02-04-%E5%9F%BA%E4%BA%8ETesseract%E7%BB%84%E4%BB%B6%E7%9A%84OCR%E8%AF%86%E5%88%AB%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="w4ngzhen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CompileMind">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/04/2020-02-04-%E5%9F%BA%E4%BA%8ETesseract%E7%BB%84%E4%BB%B6%E7%9A%84OCR%E8%AF%86%E5%88%AB%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">基于Tesseract组件的OCR识别</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-04 00:00:00" itemprop="dateCreated datePublished" datetime="2020-02-04T00:00:00+08:00">2020-02-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-13 15:20:30" itemprop="dateModified" datetime="2020-10-13T15:20:30+08:00">2020-10-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景以及介绍"><a href="#背景以及介绍" class="headerlink" title="背景以及介绍"></a>背景以及介绍</h2><p>欲研究C#端如何进行图像的基本OCR识别，找到一款开源的OCR识别组件。该组件当前已经已经升级到了4.0版本。和传统的版本（3.x）比，4.0时代最突出的变化就是基于LSTM神经网络。Tesseract本身是由C++进行编写，但为了同时适配不同的语言进行调用，开放调用API并产生了诸如Java、C#、Python等主流语言在内的封装版本。本次主要研究C#封装版。</p>
<h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><p>Tesseract本身由C++编写并开源在<a target="_blank" rel="noopener" href="https://github.com/tesseract-ocr/tesseract">Github</a>，在3.X版本中，Tesseract的识别模式为字符识别，该种识别方式识别能力较低，所以在后来的4.X版本中，引入了LSTM（Long short-term memory，长短期记忆神经网络），极大的提升了识别率。为了让不同的语言均能够使用Tesseract进行OCR识别，Tesseract也是开放了API并产生了诸如Java、C#、Python等主流语言在内的封装版本。而本次C#端的封装版也开源在了<a target="_blank" rel="noopener" href="https://github.com/charlesw/tesseract">Github</a>，目前已知的C#封装版已发布在nuget上，封装了对应Tesseract的版本为3.05.02。所以目前的项目结构如下：<br><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-02-04-tesseract/版本封装.png" alt="版本封装"></p>
<h2 id="Demo实验"><a href="#Demo实验" class="headerlink" title="Demo实验"></a>Demo实验</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><h4 id="文本识别数据包准备"><a href="#文本识别数据包准备" class="headerlink" title="文本识别数据包准备"></a>文本识别数据包准备</h4><p>因为图像识别本身需要文本识别数据进行匹配，所以我们需要下载对应Tesseract官方的文本数据包：<br><a target="_blank" rel="noopener" href="https://tesseract-ocr.github.io/tessdoc/Data-Files">https://tesseract-ocr.github.io/tessdoc/Data-Files</a><br>注意，针对不同版本的Tesseract-OCR（3.X和4.X底层的实现方式不同，所以文本识别数据包是不同的），我们需要找到对应的不同的文本训练数据包，官网为了更好的兼容性，4.X版本的文本数据包是兼容了3.X版本的。</p>
<p>&gt;<br>the third set in tessdata is the only one that supports the legacy recognizer. The 4.00 files from November 2016 have both legacy and older LSTM models. The current set of files in tessdata have the legacy models and newer LSTM models (integer versions of 4.00.00 alpha models in tessdata_best).<br>&gt;</p>
<p><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-02-04-tesseract/数据包下载.png" alt="数据包下载"></p>
<p>为了Demo，我下载了中文简体和英文的数据包作为实验对象</p>
<h4 id="开发环境准备"><a href="#开发环境准备" class="headerlink" title="开发环境准备"></a>开发环境准备</h4><p>为了实验并对比上面两个封装版本的识别效果，这里在同一解决方案中创建了两个项目：<br><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-02-04-tesseract/项目创建.png" alt="项目创建"></p>
<p>BaseNewBeta使用的是封装了4.1版本Tesseract的C#封装版Tesseract.4.1.0-beta1，因为该版本还还没有上传只Nuget，所以只能从github上下载，放到本地，然后把对应的C++的底层库（leptonica-1.78.0.dll，tesseract41.dll）放置到了x86和x64文件夹下面且需要输出。</p>
<p>BaseNuget是已经上传至Nuget的封装了底层库3.05.20版本的C#封装版3.3.0.0，因为使用nuget进行组件安装，所以x64和x86的Tesseract组件会在编译输出时候自动输出到对应的生成目录。</p>
<h4 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (openFileDialog1.ShowDialog() == DialogResult.OK)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//PictureBox控件显示图片</span></span><br><span class="line">    pictureBox1.Load(openFileDialog1.FileName);</span><br><span class="line">    <span class="comment">//获取用户选择文件的后缀名 </span></span><br><span class="line">    <span class="keyword">string</span> extension = Path.GetExtension(openFileDialog1.FileName);</span><br><span class="line">    <span class="comment">//声明允许的后缀名 </span></span><br><span class="line">    <span class="keyword">string</span>[] str = <span class="keyword">new</span> <span class="keyword">string</span>[] &#123; <span class="string">&quot;.jpg&quot;</span>, <span class="string">&quot;.png&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">if</span> (!str.Contains(extension))</span><br><span class="line">    &#123;</span><br><span class="line">        MessageBox.Show(<span class="string">&quot;仅能上传jpg,png格式的图片！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//识别图片文字</span></span><br><span class="line">        Bitmap img = <span class="keyword">new</span> Bitmap(openFileDialog1.FileName);</span><br><span class="line">        <span class="comment">// 构建识别引擎</span></span><br><span class="line">        TesseractEngine orcEngine = <span class="keyword">new</span> TesseractEngine(<span class="string">&quot;./tessdata&quot;</span>, <span class="string">&quot;eng&quot;</span>);</span><br><span class="line">        <span class="comment">// 识别并获取文本数据</span></span><br><span class="line">        Page page = orcEngine.Process(img);</span><br><span class="line">        richTextBox1.Text = page.GetText();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h4><h5 id="英文识别效果"><a href="#英文识别效果" class="headerlink" title="英文识别效果"></a>英文识别效果</h5><p>先是3.X版本识别：<br><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-02-04-tesseract/EnNuget.png" alt="EnNuget"><br>可以看到文本中还有很多识别的错误的，特别是把英文字符C识别为了括号（。<br>而封装了新版本的识别结果比起之前更好：<br><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-02-04-tesseract/EnNewBeta.png" alt="EnNewBeta"></p>
<h5 id="中文识别效果"><a href="#中文识别效果" class="headerlink" title="中文识别效果"></a>中文识别效果</h5><p>先是3.X版本识别：<br><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-02-04-tesseract/CNNuget.png" alt="CNNuget"><br>然后是封装的版本：<br><img src="https://cdn.jsdelivr.net/gh/w4ngzhen/CDN/images/post/2020-02-04-tesseract/CNNewBeta.png" alt="CNNewBeta"><br>看的出来，官方的数据包对于中文的识别还是有很大问题的，不过庆幸的是，4.X版本的后的Tesseract支持我们使用的自己的数据进行识别训练。这样一来，虽然该组件还比不上市面上大多数的商业OCR识别，但是我们可以使用训练数据，来训练适用于我们特定业务的文字识别（比如XX码的提取之类）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://compilemind.com/2019/02/25/2019-02-25-%E9%82%A3%E4%BA%9B%E6%88%91%E7%94%A8Windows%E6%97%B6%E5%BF%85%E5%A4%87%E7%9A%84%E8%BD%AF%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="w4ngzhen">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CompileMind">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/25/2019-02-25-%E9%82%A3%E4%BA%9B%E6%88%91%E7%94%A8Windows%E6%97%B6%E5%BF%85%E5%A4%87%E7%9A%84%E8%BD%AF%E4%BB%B6/" class="post-title-link" itemprop="url">那些我用Windows时必备的软件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-02-25 00:00:00" itemprop="dateCreated datePublished" datetime="2019-02-25T00:00:00+08:00">2019-02-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-13 15:20:30" itemprop="dateModified" datetime="2020-10-13T15:20:30+08:00">2020-10-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="坚果云"><a href="#坚果云" class="headerlink" title="坚果云"></a><a target="_blank" rel="noopener" href="https://www.jianguoyun.com/s/downloads">坚果云</a></h1><h1 id="Microsoft-YaHei-Mono-字体-（提取码：epsq）"><a href="#Microsoft-YaHei-Mono-字体-（提取码：epsq）" class="headerlink" title="Microsoft YaHei Mono 字体 （提取码：epsq）"></a><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1WuCJ5VW7nypzp4dgCTcMtQ">Microsoft YaHei Mono 字体</a> （提取码：epsq）</h1><h1 id="7-Zip"><a href="#7-Zip" class="headerlink" title="7-Zip"></a><a target="_blank" rel="noopener" href="https://www.7-zip.org/">7-Zip</a></h1><h1 id="AIDA64Extreme"><a href="#AIDA64Extreme" class="headerlink" title="AIDA64Extreme"></a><a target="_blank" rel="noopener" href="https://www.aida64.com/downloads">AIDA64Extreme</a></h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key：FARRD-CU2D6-J9D59-LD2Q4-3AJG7</span><br></pre></td></tr></table></figure>
<h1 id="apache-maven"><a href="#apache-maven" class="headerlink" title="apache-maven"></a><a target="_blank" rel="noopener" href="http://maven.apache.org/download.cgi">apache-maven</a></h1><ol>
<li>环境变量设置</li>
<li>阿里镜像配置<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// bin目录conf中复制一份settings.xml到用户目录/.m2/下（没有就手动创建）</span><br><span class="line">// 在settings.xml的mirrors节点下面添加如下子节点</span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-aliyun<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus aliyun<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>命令行进行初始化<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn help:system</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="BaiduNetdisk"><a href="#BaiduNetdisk" class="headerlink" title="BaiduNetdisk"></a><a target="_blank" rel="noopener" href="https://pan.baidu.com/download">BaiduNetdisk</a></h1><h1 id="VLC-media-player"><a href="#VLC-media-player" class="headerlink" title="VLC media player"></a><a target="_blank" rel="noopener" href="https://www.videolan.org/">VLC media player</a></h1><h1 id="滴答清单"><a href="#滴答清单" class="headerlink" title="滴答清单"></a><a target="_blank" rel="noopener" href="https://www.dida365.com/about/download">滴答清单</a></h1><h1 id="eudic"><a href="#eudic" class="headerlink" title="eudic"></a><a target="_blank" rel="noopener" href="https://www.eudic.net/v4/en/app/eudic">eudic</a></h1><h1 id="Everything"><a href="#Everything" class="headerlink" title="Everything"></a><a target="_blank" rel="noopener" href="https://www.voidtools.com/zh-cn/">Everything</a></h1><h1 id="FSCapture"><a href="#FSCapture" class="headerlink" title="FSCapture"></a><a target="_blank" rel="noopener" href="https://faststone.org/FSCaptureDownload.htm">FSCapture</a></h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name：bluman</span><br><span class="line">key：VPISCJULXUFGDDXYAUYF</span><br></pre></td></tr></table></figure>
<h1 id="Git"><a href="#Git" class="headerlink" title="Git"></a><a target="_blank" rel="noopener" href="https://git-scm.com/downloads">Git</a></h1><h1 id="grepWin"><a href="#grepWin" class="headerlink" title="grepWin"></a><a target="_blank" rel="noopener" href="https://github.com/stefankueng/grepWin/releases">grepWin</a></h1><h1 id="ILSpy"><a href="#ILSpy" class="headerlink" title="ILSpy"></a><a target="_blank" rel="noopener" href="https://github.com/icsharpcode/ILSpy/releases">ILSpy</a></h1><h1 id="jdk8（AdoptOpenJDK）"><a href="#jdk8（AdoptOpenJDK）" class="headerlink" title="jdk8（AdoptOpenJDK）"></a><a target="_blank" rel="noopener" href="https://adoptopenjdk.net/releases.html?variant=openjdk8&amp;jvmVariant=hotspot">jdk8（AdoptOpenJDK）</a></h1><ol>
<li>环境变量设置</li>
</ol>
<h1 id="JetBrains-IntelliJ-IDEA"><a href="#JetBrains-IntelliJ-IDEA" class="headerlink" title="JetBrains IntelliJ IDEA"></a><a target="_blank" rel="noopener" href="https://www.jetbrains.com/idea/download/">JetBrains IntelliJ IDEA</a></h1><h1 id="Microsoft-Visual-Studio"><a href="#Microsoft-Visual-Studio" class="headerlink" title="Microsoft Visual Studio"></a><a target="_blank" rel="noopener" href="https://visualstudio.microsoft.com/zh-hans/vs/">Microsoft Visual Studio</a></h1><h1 id="nodejs"><a href="#nodejs" class="headerlink" title="nodejs"></a><a target="_blank" rel="noopener" href="https://nodejs.org/en/">nodejs</a></h1><h1 id="vim"><a href="#vim" class="headerlink" title="vim"></a><a target="_blank" rel="noopener" href="https://www.vim.org/">vim</a></h1><h1 id="PicGo"><a href="#PicGo" class="headerlink" title="PicGo"></a><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/PicGo/releases">PicGo</a></h1><h1 id="R"><a href="#R" class="headerlink" title="$$R"></a><a target="_blank" rel="noopener" href="https://github.com/shadowsocks/shadowsocks-windows/releases">$$R</a></h1><h1 id="SumatraPDF"><a href="#SumatraPDF" class="headerlink" title="SumatraPDF"></a><a target="_blank" rel="noopener" href="https://github.com/sumatrapdfreader/sumatrapdf/releases">SumatraPDF</a></h1><h1 id="Thunder-Network-提取码：ufce"><a href="#Thunder-Network-提取码：ufce" class="headerlink" title="Thunder Network (提取码：ufce)"></a><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1b8mJY_wwGO8zt0nCDVW86Q">Thunder Network</a> (提取码：ufce)</h1><h1 id="Typora"><a href="#Typora" class="headerlink" title="Typora"></a><a target="_blank" rel="noopener" href="https://typora.io/">Typora</a></h1><h1 id="uTools"><a href="#uTools" class="headerlink" title="uTools"></a><a target="_blank" rel="noopener" href="https://u.tools/">uTools</a></h1><h1 id="AutoHotKey"><a href="#AutoHotKey" class="headerlink" title="AutoHotKey"></a><a target="_blank" rel="noopener" href="https://www.autohotkey.com/">AutoHotKey</a></h1><h1 id="WinSCP"><a href="#WinSCP" class="headerlink" title="WinSCP"></a><a target="_blank" rel="noopener" href="https://winscp.net/eng/download.php">WinSCP</a></h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="w4ngzhen"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">w4ngzhen</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">44</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/w4ngzhen" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;w4ngzhen" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">w4ngzhen</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
